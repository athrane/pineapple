<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 from src\site\apt/examples\operation-with-execution-result.apt at 22 Dec 2018
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Allan Thrane Andersen" />
    <meta name="Date-Revision-yyyymmdd" content="20181222" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Pineapple API project &#x2013; How-to: Write a operation whose outcome is reported using the execution framework</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script type="text/javascript" src="../js/apache-maven-fluido-1.7.min.js"></script>
    <!-- Google Analytics -->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-28287414-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Pineapple API project</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
      <li class=""><a href="../../../index.html" title="Pineapple Home">Pineapple Home</a><span class="divider">/</span></li>
      <li class=""><a href="../../index.html" title="Pineapple modules">Pineapple modules</a><span class="divider">/</span></li>
      <li class=""><a href="../index.html" title="Pineapple API project">Pineapple API project</a><span class="divider">/</span></li>
    <li class="active ">How-to: Write a operation whose outcome is reported using the execution framework</li>
        <li id="publishDate" class="pull-right">Last Published: 22 Dec 2018</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">Project Overview</li>
    <li><a href="../../../index.html" title="Home"><span class="none"></span>Home</a></li>
    <li><a href="../../../usage/installation.html" title="Installation"><span class="none"></span>Installation</a></li>
    <li><a href="../../../usage/index.html" title="For Users"><span class="none"></span>For Users</a></li>
    <li><a href="../../../development/index.html" title="For Developers"><span class="none"></span>For Developers</a></li>
    <li><a href="../../../usage/terms.html" title="Terms and Conditions"><span class="none"></span>Terms and Conditions</a></li>
      <li class="nav-header">Clients</li>
    <li><a href="../../../pineapple-applications/pineapple-web-application/pineapple-standalone-web-client/index.html" title="Standalone Web Application"><span class="none"></span>Standalone Web Application</a></li>
    <li><a href="../../../pineapple-applications/pineapple-web-application/pineapple-web-application-war/index.html" title="Deployable Web Application"><span class="none"></span>Deployable Web Application</a></li>
    <li><a href="../../../pineapple-applications/pineapple-maven-plugin/index.html" title="Maven Plugin"><span class="none"></span>Maven Plugin</a></li>
      <li class="nav-header">Plugins</li>
    <li><a href="../../../pineapple-plugins/pineapple-agent-plugin/index.html" title="Agent"><span class="none"></span>Agent</a></li>
    <li><a href="../../../pineapple-plugins/pineapple-composite-execution-plugin/index.html" title="Composite Execution"><span class="none"></span>Composite Execution</a></li>
    <li><a href="../../../pineapple-plugins/pineapple-ssh-plugin/index.html" title="SSH"><span class="none"></span>SSH</a></li>
    <li><a href="../../../pineapple-plugins/pineapple-docker-plugin/index.html" title="Docker"><span class="none"></span>Docker</a></li>
    <li><a href="../../../pineapple-modules/pineapple-infrastructure-test-plugin/index.html" title="Infrastructure Test"><span class="none"></span>Infrastructure Test</a></li>
      <li class="nav-header">API's</li>
    <li><a href="../../../pineapple-applications/pineapple-web-application/pineapple-web-application-war/usage/rest.html" title="REST"><span class="none"></span>REST</a></li>
    <li><a href="../../../development/plugin-framework.html" title="Plugin Framework"><span class="none"></span>Plugin Framework</a></li>
      <li class="nav-header">Additional Information</li>
    <li><a href="http://pineapplesoftware.blogspot.com" class="externalLink" title="The Pineapple Project Blog"><span class="none"></span>The Pineapple Project Blog</a></li>
    <li><a href="http://exceptiontrail.blogspot.com" class="externalLink" title="Pineapple Exception Trail Blog"><span class="none"></span>Pineapple Exception Trail Blog</a></li>
      <li class="nav-header">Project Tools</li>
    <li><a href="https://bintray.com/pineapple/maven/com.alpha.pineapple" class="externalLink" title="Downloads"><span class="none"></span>Downloads</a></li>
    <li><a href="https://github.com/athrane/pineapple" class="externalLink" title="Source Code"><span class="none"></span>Source Code</a></li>
    <li><a href="https://github.com/athrane/pineapple/issues" class="externalLink" title="Issue Tracker"><span class="none"></span>Issue Tracker</a></li>
      <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
</ul>
          <hr />
          <div id="poweredBy">
    <script type="text/javascript">asyncJs( 'https://apis.google.com/js/plusone.js' )</script>
    <div class="g-plusone" data-href="https://pineapple.dev.java.net" data-size="tall" ></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<div class="section">
<h2><a name="How-to:_Write_a_operation_whose_outcome_is_reported_using_the_execution_framework"></a>How-to: Write a operation whose outcome is reported using the execution framework</h2>
<div class="section">
<h3><a name="Introduction"></a>Introduction</h3>
<p>This example illustrates how to write a operation class which uses the execution framework, i.e. reports the outcome of the execution by using the execution result object.</p>
<p>The class <tt>com.alpha.pineapple.plugin.net.operation.TestDeployedConfiguration</tt> is used an example. The class is part of the infrastructure test plugin where it implements the <i>test-deployed-configuration</i> operation.</p></div>
<div class="section">
<h3><a name="The_full_example"></a>The full example</h3>
<div class="source"><pre class="prettyprint linenums">
@PluginOperation( OperationNames.TEST_DEPLOYED_CONFIGURATION )
public class TestDeployedConfiguration implements Operation
{
    Logger logger = Logger.getLogger( this.getClass().getName() );
    
    /**
     * Commands
     */
    @Resource
    Command testResolveNameToIpAddressCommand;

    @Resource
    Command testHostListenPortCommand;

    @Resource
    Command testLoadBalancingCommand;

    @Resource
    Command testStickynessCommand;

    @Resource    
    Command testHttpRedirectCommand;

    @Resource        
    Command testHttpHeaderCommand;

    @Resource        
    Command testUncPathCommand;
    
    // Command runner
    @Resource
    CommandRunner commandRunner;   
    
    // Model mapper object.
    @Resource    
    Mapper mapper;
    
    // Message provider for I18N support.
    @Resource
    MessageProvider messageProvider;
       
    public void execute( Object content, Session session, ExecutionResult executionResult ) throws PluginExecutionFailedException
    {           
        // validate parameters
        Validate.notNull( content, &quot;content is undefined.&quot; );
        Validate.notNull( session, &quot;session is undefined.&quot; );
        Validate.notNull( executionResult, &quot;executionResult is undefined.&quot; );        
        
        // log debug message
        if ( logger.isDebugEnabled() ) 
        {
                Object[] args = { content.getClass().getName(), content };                      
                String message = messageProvider.getMessage(&quot;tdc.start&quot;, args );
                logger.debug( message );
        }

        // throw exception if required type isn't available
        if ( !( content instanceof Infrastructure ) )
        {
                Object[] args = { Infrastructure.class };                       
                String message = messageProvider.getMessage(&quot;tdc.content_typecast_failed&quot;, args );
            throw new PluginExecutionFailedException( message );
        }
        
        // configure command runner with execution result
        commandRunner.setExecutionResult( executionResult );
        
        try
        {
            // type cast to infrastructure model object
            Infrastructure model = (Infrastructure) content;

            // put proxies into a map
            HashMap&lt;String, Proxy&gt; proxyMap = new HashMap&lt;String, Proxy&gt;();
            for ( Proxy proxy : model.getProxy() )
            {
                proxyMap.put( proxy.getId(), proxy );
            }

            // run tests
            runResolveToIpTests( model );
            runHostListenPortTests( model );
            runStickynessTests( model, proxyMap );            
            runLoadBalancingTests( model, proxyMap );
            runHttpRedirectTests( model, proxyMap );
            runHttpHeaderTests( model, proxyMap );
            runFtpServerActiveTests( model );        
            runFtpServerContainsDirectoryTests( model );
            runFtpServerCreateDirectoryTests( model );
            runAccessUncPathTests( model );
            
            // compute execution state from children
            executionResult.completeAsComputed(messageProvider, &quot;tdc.completed&quot;, null, &quot;tdc.failed&quot;, null );                                    
        }
        catch ( CommandException e )
        {
                Object[] args = { StackTraceHelper.getStrackTrace( e ) };                       
                String message = messageProvider.getMessage(&quot;tdc.error&quot;, args );
            throw new PluginExecutionFailedException( message, e );
        }
    }       
 
        // all of the test methods goes here...    
}    
    
</pre></div></div>
<div class="section">
<h3><a name="Usage_of_the_execution_framework"></a>Usage of the execution framework</h3>
<div class="section">
<h4><a name="Purpose_of_the_execution_result"></a>Purpose of the execution result</h4>
<p>The execution result object is used to report the outcome of the operation. The result execution is used to capture one of three outcomes:</p>
<ul>
<li>The operation succeeded, i.e. all executed child tests succeeded.</li>
<li>The operation failed, i.e. all least one executed child test failed or terminated with an error. </li>
<li>The operation terminated with an error.</li></ul></div>
<div class="section">
<h4><a name="Who_creates_the_execution_result_object_for_the_command"></a>Who creates the execution result object for the command</h4>
<p>It is the responsibility of the code which executes the operation to create a execution result object which can be used by the operation to report the outcome of it execution. </p>
<p>The execution result for the operation is created by the Pineapple core component in the class <tt>com.alpha.pineapple.command.InvokePluginsCommand</tt>. </p></div>
<div class="section">
<h4><a name="Injection_of_the_execution_result_object_into_the_operation"></a>Injection of the execution result object into the operation</h4>
<p>The execution result object is the 3rd argument in the <tt>Execute(Object content, Session session, ExecutionResult executionResult)</tt> method in the <tt>com.alpha.pineapple.plugin.Operation</tt> interface which is implemented by all operations. </p></div>
<div class="section">
<h4><a name="Injection_of_the_command_runner_into_the_operation"></a>Injection of the command runner into the operation</h4>
<p>The operation uses a command runner object to execute test commands and capture the outcome of the execution of each command in a separate execution result object.</p>
<p>The command runner is defined as a annotated field on the operation and injects using the Spring dependency injection mechanism:</p>
<div class="source"><pre class="prettyprint linenums">    /**
     * Command runner
     */
    @Resource
    CommandRunner commandRunner;        
</pre></div></div>
<div class="section">
<h4><a name="Setting_up_the_command_runner_to_capture_the_results_of_test_commands"></a>Setting up the command runner to capture the results of test commands</h4>
<p>The command runner is configured with the execution result for the operation prior to running any commands:</p>
<div class="source"><pre class="prettyprint linenums">    // configure command runner with execution result
    commandRunner.setExecutionResult( executionResult );
</pre></div>
<p>Afterwards when the runner invoked to run a command, it will create a child execution object from the operation execution result object and use the child to capture the execution of the commands:</p>
<div class="source"><pre class="prettyprint linenums">  void runHostListenPortTests( Infrastructure model ) throws CommandException
    {
        for ( HostListenPortTest test : model.getHostListenPortTest() )
        {
                // create description
                String description = &quot;..some description....&quot;
                
            // create context
            Context context = commandRunner.createContext();
                
            // map model content to context
            mapper.mapHostListenPortTest( test, context );
                
            // run test            
            commandRunner.run(testHostListenPortCommand, description, context);
        }
    }   
</pre></div></div>
<div class="section">
<h4><a name="Implementing_the_successful_and_failed_operation_outcome"></a>Implementing the successful and failed operation outcome</h4>
<p>Whether the operation succeeds or fails depends on the outcome of the tests which are executed by the operation. The tests are implemented as Chain commands and the outcome of their execution is captured in child execution results which are created by the command runner when each test is run.</p>
<p>After all tests are run the operation computes its final state by invoking the <tt>completeAsComputed(...)</tt> method and the operation is done executing:</p>
<div class="source"><pre class="prettyprint linenums">  public void execute( Object content, Session session, ExecutionResult executionResult ) throws PluginExecutionFailedException
    {           
        // some sanity tests and logging here 
                        
        // configure command runner with execution result
        commandRunner.setExecutionResult( executionResult );
        
        try
        {
            // type cast to infrastructure model object
            Infrastructure model = (Infrastructure) content;

            // put proxies into a map
            HashMap&lt;String, Proxy&gt; proxyMap = .....;

            // run tests
            runResolveToIpTests( model );
            runHostListenPortTests( model );
            runStickynessTests( model, proxyMap );            
            runLoadBalancingTests( model, proxyMap );
            runHttpRedirectTests( model, proxyMap );
            runHttpHeaderTests( model, proxyMap );
            runFtpServerActiveTests( model );        
            runFtpServerContainsDirectoryTests( model );
            runFtpServerCreateDirectoryTests( model );
            runAccessUncPathTests( model );
            
            // compute execution state from children
            executionResult.completeAsComputed(messageProvider, &quot;tdc.completed&quot;, null, &quot;tdc.failed&quot;, null );                    
        }
        catch ( CommandException e )
        {
                Object[] args = { StackTraceHelper.getStrackTrace( e ) };                       
                String message = messageProvider.getMessage(&quot;tdc.error&quot;, args );
            throw new PluginExecutionFailedException( message, e );
        }
    }
</pre></div></div>
<div class="section">
<h4><a name="Implementing_when_the_operation_terminates_with_an_error"></a>Implementing when the operation terminates with an error</h4>
<p>If the operation terminates with an error then the state of the execution result object <i>isn't</i> updated. </p>
<p>The operation should catch any exception it knows could occur in its code and then rethrow it as an <tt>PluginExecutionFailedException</tt>:</p>
<div class="source"><pre class="prettyprint linenums">public void execute( Object content, Session session, ExecutionResult executionResult ) throws PluginExecutionFailedException
    {                   
        try
        {
            // logic, logic 
                        
            // compute execution state from children
            executionResult.completeAsComputed(messageProvider, &quot;tdc.completed&quot;, null, &quot;tdc.failed&quot;, null );                    
        }
        catch ( CommandException e )
        {
                Object[] args = { StackTraceHelper.getStrackTrace( e ) };                       
                String message = messageProvider.getMessage(&quot;tdc.error&quot;, args );
            throw new PluginExecutionFailedException( message, e );
        }
    }

</pre></div>
<p>The <tt>PluginExecutionFailedException</tt> and any other exception will be caught by Pineapple in the class <tt>InvokePluginsCommand</tt> which will update the state of the operation execution result object to <i>error</i>. The error handling in Pineapple could code look something like like: </p>
<div class="source"><pre class="prettyprint linenums">
  try {
    // invoke operation
    operation.execute( moduleModel, session, modelResult );    
                        
  } catch (Exception e) {

    // set result with error
    modelResult.completeAsError(messageProvider, &quot;ipc.error&quot;, null, e)
}
</pre></div></div></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
Copyright (C) 2007-2017 Allan Thrane Andersen. All Rights Reserved.
        </div>
      </div>
    </footer>
  </body>
</html>
