<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 from src\site\apt/development\initialization.apt at 09 Jun 2019
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Allan Thrane Andersen" />
    <meta name="Date-Revision-yyyymmdd" content="20190609" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Pineapple core component &#x2013; Core component initialization</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script type="text/javascript" src="../js/apache-maven-fluido-1.7.min.js"></script>
    <!-- Google Analytics -->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-28287414-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Pineapple core component</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
      <li class=""><a href="../../../index.html" title="Pineapple Home">Pineapple Home</a><span class="divider">/</span></li>
      <li class=""><a href="../../index.html" title="Pineapple modules">Pineapple modules</a><span class="divider">/</span></li>
      <li class=""><a href="../index.html" title="Pineapple core component">Pineapple core component</a><span class="divider">/</span></li>
    <li class="active ">Core component initialization</li>
        <li id="publishDate" class="pull-right">Last Published: 09 Jun 2019</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">Project Overview</li>
    <li><a href="../../../index.html" title="Home"><span class="none"></span>Home</a></li>
    <li><a href="../../../usage/installation.html" title="Installation"><span class="none"></span>Installation</a></li>
    <li><a href="../../../usage/index.html" title="For Users"><span class="none"></span>For Users</a></li>
    <li><a href="../../../development/index.html" title="For Developers"><span class="none"></span>For Developers</a></li>
    <li><a href="../../../usage/terms.html" title="Terms and Conditions"><span class="none"></span>Terms and Conditions</a></li>
      <li class="nav-header">Clients</li>
    <li><a href="../../../pineapple-applications/pineapple-web-application/pineapple-standalone-web-client/index.html" title="Standalone Web Application"><span class="none"></span>Standalone Web Application</a></li>
    <li><a href="../../../pineapple-applications/pineapple-web-application/pineapple-web-application-war/index.html" title="Deployable Web Application"><span class="none"></span>Deployable Web Application</a></li>
    <li><a href="../../../pineapple-applications/pineapple-maven-plugin/index.html" title="Maven Plugin"><span class="none"></span>Maven Plugin</a></li>
      <li class="nav-header">Plugins</li>
    <li><a href="../../../pineapple-plugins/pineapple-agent-plugin/index.html" title="Agent"><span class="none"></span>Agent</a></li>
    <li><a href="../../../pineapple-plugins/pineapple-composite-execution-plugin/index.html" title="Composite Execution"><span class="none"></span>Composite Execution</a></li>
    <li><a href="../../../pineapple-plugins/pineapple-ssh-plugin/index.html" title="SSH"><span class="none"></span>SSH</a></li>
    <li><a href="../../../pineapple-plugins/pineapple-git-plugin/index.html" title="Git"><span class="none"></span>Git</a></li>
    <li><a href="../../../pineapple-plugins/pineapple-docker-plugin/index.html" title="Docker"><span class="none"></span>Docker</a></li>
    <li><a href="../../../pineapple-modules/pineapple-infrastructure-test-plugin/index.html" title="Infrastructure Test"><span class="none"></span>Infrastructure Test</a></li>
      <li class="nav-header">API's</li>
    <li><a href="../../../pineapple-applications/pineapple-web-application/pineapple-web-application-war/usage/rest.html" title="REST"><span class="none"></span>REST</a></li>
    <li><a href="../../../development/plugin-framework.html" title="Plugin Framework"><span class="none"></span>Plugin Framework</a></li>
      <li class="nav-header">Additional Information</li>
    <li><a href="http://pineapplesoftware.blogspot.com" class="externalLink" title="The Pineapple Project Blog"><span class="none"></span>The Pineapple Project Blog</a></li>
    <li><a href="http://exceptiontrail.blogspot.com" class="externalLink" title="Pineapple Exception Trail Blog"><span class="none"></span>Pineapple Exception Trail Blog</a></li>
      <li class="nav-header">Project Tools</li>
    <li><a href="https://bintray.com/pineapple/maven/com.alpha.pineapple" class="externalLink" title="Downloads"><span class="none"></span>Downloads</a></li>
    <li><a href="https://github.com/athrane/pineapple" class="externalLink" title="Source Code"><span class="none"></span>Source Code</a></li>
    <li><a href="https://github.com/athrane/pineapple/issues" class="externalLink" title="Issue Tracker"><span class="none"></span>Issue Tracker</a></li>
      <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
</ul>
          <hr />
          <div id="poweredBy">
    <script type="text/javascript">asyncJs( 'https://apis.google.com/js/plusone.js' )</script>
    <div class="g-plusone" data-href="https://pineapple.dev.java.net" data-size="tall" ></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<div class="section">
<h2><a name="Core_component_initialization"></a>Core component initialization</h2>
<p>The initialization takes place when a client creates a new instance of the core component.</p>
<div class="section">
<h3><a name="How_the_core_component_is_created_and_initialized"></a>How the core component is created and initialized </h3>
<p>The core component is created by clients through a factory method on the <tt>CoreFactory</tt> class to create an instance of the core component with its dependencies initialized and injected by Spring.</p></div>
<div class="section">
<h3><a name="Two_execution_paths_for_initialization_of_the_core_component"></a>Two execution paths for initialization of the core component</h3>
<p>Two general execution paths are implemented for initialization of the core component:</p>
<ol style="list-style-type: decimal">
<li>The core component is created with no parameters other than Java system properties.</li>
<li>The core component is created with parameters besides Java system properties. The parameters are
<ul>
<li>The <tt>provider</tt> defines the supplied credential provider object, which is used by the core component during operation execution to lookup security credentials for accessed resources. </li>
<li>The <tt>resources</tt> argument defines the file where the core component will load resources from the environment configuration.</li></ul></li></ol>
<p>The reason for using the term <i>two general execution paths</i> is because the second path comes in three variants:</p>
<ol style="list-style-type: decimal">
<li>Credential provider + absolute path to resources file. </li>
<li>Credential provider + resources file name with no path. </li>
<li>Credential provider, no resource file parameter. </li></ol>
<div class="section">
<h4><a name="Doesn.27t_result_listeners_count_as_parameters.3F"></a>Doesn't result listeners count as parameters?</h4>
<p>Inspection of the core factory API reveals that it contain factory methods with additional parameters, i.e the result listener array.</p>
<p>This parameter is ignored in the above explanation since they are applied to the core component prior to its actual initialization to support the publisher-subscribe pattern for clients to subscribe to events which describes how the initialization proceeds. </p></div>
<div class="section">
<h4><a name="Note_about_numbering_of_steps_in_the_execution_paths"></a>Note about numbering of steps in the execution paths</h4>
<p>The numbering of steps is identical in the two execution paths to be able to reference and document a particular step in both execution paths. </p></div>
<div class="section">
<h4><a name="Execution_path_for_initialization_of_the_core_component_with_no_parameters"></a>Execution path for initialization of the core component with no parameters</h4>
<ol style="list-style-type: decimal">
<li>The client invokes one of:
<ul>
<li><tt>CoreFactory.createCore()</tt> </li>
<li><tt>CoreFactory.createCore(ResultListener[] listeners)</tt></li></ul></li>
<li>The core component is looked up from the core component Spring application context:
<ol style="list-style-type: decimal">
<li>The core component Spring application context <tt>com.alpha.pineapple.core-config.xml</tt> is loaded.</li>
<li>The initialization of the context triggers the creation of an <b>uninitialized</b> core component and the initialization of is its main dependencies
<ol style="list-style-type: decimal">
<li>The runtime directory provider is initialized.</li>
<li>The result repository is injected.</li>
<li>The module repository is injected. </li>
<li>A uninitialized core component instance is created.</li></ol></li>
<li>A uninitialized core component instance is looked up from the application context.</li>
<li>if the factory was invoked with an array of result listeners then they are registered with the core component.</li></ol></li>
<li>The <b>uninitialized</b> core component is initialized by invoking <tt>CoreImpl.initialize()</tt> which:
<ol style="list-style-type: decimal">
<li>Initialize the home directory.</li>
<li>Create default environment configuration.</li>
<li>Load the resources configuration.</li>
<li>Initialize plugin activator.</li>
<li>Initialize the administration API.</li>
<li>Initialize the module repository. </li>
<li>Initialize the scheduled operation repository. </li></ol></li></ol></div>
<div class="section">
<h4><a name="Execution_path_for_initialization_of_the_core_component_with_parameters"></a>Execution path for initialization of the core component with parameters </h4>
<ol style="list-style-type: decimal">
<li>The client invokes one of:
<ul>
<li><tt>CoreFactory.createCore(CredentialProvider provider)</tt> </li>
<li><tt>CoreFactory.createCore(CredentialProvider provider, ResultListener[] listeners)</tt></li>
<li><tt>CoreFactory.createCore(CredentialProvider provider, File resources)</tt> </li>
<li><tt>CoreFactory.createCore(CredentialProvider provider, File resources, ResultListener[] listeners)</tt> </li></ul></li>
<li>The core component is looked up from the core component Spring application context:
<ol style="list-style-type: decimal">
<li>The core component Spring application context <tt>com.alpha.pineapple.core-config.xml</tt> is loaded.</li>
<li>The initialization of the context triggers the creation of an <b>uninitialized</b> core component and the initialization of is its main dependencies
<ol style="list-style-type: decimal">
<li>The runtime directory provider is initialized.</li>
<li>The result repository is injected.</li>
<li>The module repository is injected. </li>
<li>A uninitialized core component instance is created.</li></ol></li>
<li>A uninitialized core component instance is looked up from the application context.</li>
<li>if the factory was invoked with an array of result listeners then they are registered with the core component.</li></ol></li>
<li>The <b>uninitialized</b> core component is initialized by invoking either <tt>CoreImpl.initialize(provider)</tt> or <tt>CoreImpl.initialize(provider, resources)</tt> which:
<ol style="list-style-type: decimal">
<li>Load the resources configuration.</li>
<li>Initialize plugin activator.</li>
<li>Initialize the administration API.</li>
<li>Initialize the module repository. </li>
<li>Initialize the scheduled operation repository. </li></ol></li></ol></div></div>
<div class="section">
<h3><a name="Step_2.2.1:_Initialization_of_the_runtime_directory_provider"></a>Step 2.2.1: Initialization of the runtime directory provider</h3>
<p>The runtime directory provider use this algorithm to resolve the <b>Pineapple Home Directory</b>:</p>
<ol style="list-style-type: decimal">
<li>If the system property <a href="./system-properties.html"><tt>pineapple.home.dir</tt></a> is set then the home directory is resolved to this directory.</li>
<li>If the system property isn't defined then Pineapple will resolve to its home directory to: <tt>${user.home}/.pineapple</tt></li></ol>
<p>The operating system is determined on the value of the <tt>os.name</tt> system property. </p>
<p><tt>${user.home}</tt> is the value of the <tt>user.home</tt> system property. </p></div>
<div class="section">
<h3><a name="Step_2.2.2:_Injection_of_result_repository"></a>Step 2.2.2: Injection of result repository</h3>
<p>The core component is injected with an instance of <tt>ResultRepositoryImpl</tt> which implements the <tt>ResultRepository</tt> interface. The result repository implements the role of subject in the observer pattern where interested parties can register themselves for notification when operations are executed. </p></div>
<div class="section">
<h3><a name="Step_2.2.3:_Injection_of_module_repository"></a>Step 2.2.3: Injection of module repository</h3>
<p>The core component is injected with an instance of <tt>DirectoryBasedModuleRepositoryImpl</tt> which implements the <tt>ModuleRepository</tt> interface. </p>
<p>The repository administers a set of available modules resolved from the modules directory. The modules directory is resolved from the runtime directory provider. </p>
<p>The injected module repository isn't initialized yet at this point. The repository is initialized with the set of available modules in step 3.5.</p></div>
<div class="section">
<h3><a name="Step_3:_Initialization_of_the_core_component_proper"></a>Step 3: Initialization of the core component proper </h3>
<div class="section">
<h4><a name="Two_different_execution_paths"></a>Two different execution paths </h4>
<p>The <tt>CoreImpl.initialize(..)</tt> method is where the two different execution paths are implemented:</p>
<ol style="list-style-type: decimal">
<li>The core component is created with no parameters other than Java system properties.</li>
<li>The core component is created with parameters besides Java system properties. The parameters are
<ul>
<li>A credential provider instance. </li>
<li>A file defining where the resources should be loaded from.</li></ul></li></ol></div>
<div class="section">
<h4><a name="The_difference_between_the_two_executions_path"></a>The difference between the two executions path </h4>
<p>The difference between the two paths is that creation of runtime directories and default configuration (e.g. step 3.1 and 3.2) is <b>omitted</b> when the client invokes the core component with parameters since it it assumed that the client have taken the required steps to ensure that the resource configuration file and directories are present prior to initialization. </p></div>
<div class="section">
<h4><a name="Details_about_the_supported_CoreImpl.initialize.28...29_methods"></a>Details about the supported <tt>CoreImpl.initialize(..)</tt> methods</h4>
<div class="section">
<h5><a name="CoreImpl.initialize.28.29"></a><tt>CoreImpl.initialize()</tt></h5>
<p>This method is the execution path with no parameters. </p></div>
<div class="section">
<h5><a name="CoreImpl.initialize.28provider.29"></a><tt>CoreImpl.initialize(provider)</tt> </h5>
<p>This method is part of the execution path with parameters.</p>
<p>When <tt>CoreImpl.initialize(provider)</tt> is invoked then the core component assumes:</p>
<ul>
<li>The resources file is named <tt>resources.xml</tt></li>
<li>The resources file is located on the class path.</li></ul>
<p>..and thus invokes <tt>CoreImpl.initialize(provider, resources)</tt> with a file object with no absolute path but only the file name <tt>resources.xml</tt>.</p></div>
<div class="section">
<h5><a name="CoreImpl.initialize.28provider.2C_resource.29"></a><tt>CoreImpl.initialize(provider, resource)</tt> </h5>
<p>This method is the main entrance to the execution path with parameters.</p></div></div></div>
<div class="section">
<h3><a name="Step_3.1:_Initialization_of_the_home_directory"></a>Step 3.1: Initialization of the home directory </h3>
<p>The core component uses the chain command <tt>InitializeHomeDirectoriesCommand</tt> process the directories. The command use the runtime directory provider for resolution of all directories. The runtime directory provider was initialized in step 2.2.1.</p>
<p>The command creates the home directory and sub directories:</p>
<ul>
<li>The home directory</li>
<li>The configuration directory </li>
<li>The modules directory </li>
<li>The reports directory </li></ul></div>
<div class="section">
<h3><a name="Step_3.2:_Create_default_environment_configuration"></a>Step 3.2: Create default environment configuration</h3>
<p>The core component uses the chain command <tt>CreateDefaultEnvironmentConfigurationCommand</tt> to create a default configuration if no home directory, sub directories and environment configuration files exists.</p>
<p>The command performs the initialization:</p>
<ul>
<li>If an resources file exists (i.e. <tt>resources.xml</tt>) then the command exits.</li>
<li>If an credentials file exists (i.e. the <tt>credential.xml</tt>) then the command exits. </li>
<li>If an credentials file exists (i.e. the <tt>credential.xml</tt>) then the command exits. </li>
<li>A default resources file is created in the configuration directory.</li>
<li>A default credentials file is created in the configuration directory. </li></ul></div>
<div class="section">
<h3><a name="Step_3.3:_Load_the_resources_configuration"></a>Step 3.3: Load the resources configuration</h3>
<p>The core component attempts to load the resources from the environment configuration using the <tt>resources</tt> argument supplied as argument to the constructor. The core component uses the chain command <tt>LoadEnvironmentConfigurationCommand</tt> to load the file and bind it to the schema defined in the pineapple-api project.</p>
<p>For more information about the used schema and the environment configuration in general, <a href="../../../usage/configuration-environment.html">refer to environment configuration reference.</a> </p></div>
<div class="section">
<h3><a name="Step_3.4:_Initialize_plugin_activator"></a>Step 3.4: Initialize plugin activator</h3>
<p>The core component uses the chain command <tt>InitializePluginActivatorCommand</tt> to initialize the plugin activator object. The command uses the resources and the credential provider to initialize the activator object. The returned plugin activator implements the interface <tt>PluginActivator</tt>. </p>
<div class="section">
<h4><a name="Step_3.4.1:_Initialization_of_the_resource_repository"></a>Step 3.4.1: Initialization of the resource repository</h4>
<p><tt>ResourceRepository.initialize( environment configuration );</tt>.</p></div>
<div class="section">
<h4><a name="Step_3.4.2:_Initialization_of_the_plugin_repository"></a>Step 3.4.2: Initialization of the plugin repository</h4>
<p>The initialization of repository is done by invoking:</p>
<p><tt>PluginRepository.initialize( list of plugin id's );</tt>.</p>
<p>The <tt>initialize( list of plugin id's )</tt> performs these steps to initialize the repository:</p>
<ol style="list-style-type: decimal">
<li>All registered plugin id's are requested from the resources cache and resolved with the class loader. The class loader resolution is required, otherwise can't the Spring component scanner find the plugin classes. Afterwards the plugins id's are used to perform a component scan of classes which is annotated with the <tt>@Plugin</tt> annotation. All found classes are named using a custom bean naming generator <tt>com.alpha.pineapple.plugin.repository.PluginNameGeneratorImpl</tt> which generate bean names for plugins with the syntax: <tt>plugin:${package-name}</tt> where ${package-name} is the package of the found <tt>@Plugin</tt> annotated class. </li>
<li>Creates an map of <tt>PluginInfo</tt> objects. <tt>PluginInfo</tt> contains meta data about a plugin which where found during the plugin scanning. </li>
<li>Start iteration over all found plugin classes.</li>
<li>Creates <tt>PluginInfo</tt> object</li>
<li>Creates application context object for plugin. </li>
<li>Adds plugin providers to the plugin application context. These providers are initialized:
<ul>
<li>The execution info provider under the bean id &quot;coreExecutionInfoProvider&quot;.</li>
<li>The runtime directory provider under the bean id &quot;coreRuntimeDirectoryProvider&quot;.</li>
<li>The administration provider under the bean id &quot;coreAdministrationProvider&quot;.</li>
<li>The variable substitution provider under the bean id &quot;coreVariableSubstitutionProvider&quot;.</li></ul></li>
<li>Enables input marshalling if Spring configuration file can found for the plugin. Add state to <tt>PluginInfo</tt>.</li>
<li>Executes a Spring component-scan for <tt>@PluginOperation</tt> annotated classes with base in package where the plugin class is located. The found operation classes are added to the plugin application context. </li>
<li>Executes a Spring component-scan for <tt>@PluginSession</tt> annotated classes with base in package where the plugin class is located. The found session class are added to the plugin application context. </li>
<li>Enables session handling if a session class was found during component-scan (in step 9). </li>
<li>The plugin info object is added to the map and the next plugin class is processed from step 4 </li></ol></div>
<div class="section">
<h4><a name="Step_3.4.3:_Creation_of_PluginActivatorImpl_instance"></a>Step 3.4.3: Creation of <tt>PluginActivatorImpl</tt> instance </h4>
<p>A <tt>PluginActivatorImpl</tt> instance is created with three arguments:</p>
<ul>
<li>The credential provider </li>
<li>The resources repository</li>
<li>The plugin repository</li></ul></div></div>
<div class="section">
<h3><a name="Step_3.5:_Initialize_administration_API"></a>Step 3.5: Initialize administration API</h3>
<p>The core component initializes the administration API by setting the initialized credential provider to support access by clients and plugins through the API to credential provider. </p></div>
<div class="section">
<h3><a name="Step_3.6:_Initialize_module_repository"></a>Step 3.6: Initialize module repository</h3>
<p>The core component initializes the module repository by invoking the <tt>initialize()</tt> method which re-initializes the set of registered modules. </p></div>
<div class="section">
<h3><a name="Step_3.7:_Initialize_scheduled_operation_repository"></a>Step 3.7: Initialize scheduled operation repository</h3>
<p>The core component initializes the scheduled operation repository by invoking the <tt>initialize()</tt> method which re-initializes the set of registered scheduled operation.</p>
<p>The set of scheduled operations are loaded from the file:<tt>PINEAPPLE_HOME/conf/scheduled-operations.xml</tt>. </p></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
Copyright (C) 2007-2019 Allan Thrane Andersen. All Rights Reserved.
        </div>
      </div>
    </footer>
  </body>
</html>
