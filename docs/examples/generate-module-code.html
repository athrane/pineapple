<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 14 Apr 2017
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Allan Thrane Andersen" />
    <meta name="Date-Revision-yyyymmdd" content="20170414" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Pineapple Project - How-to: Write code to generate modules</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />

      
    <script type="text/javascript" src="../js/apache-maven-fluido-1.3.0.min.js"></script>

    
              <!-- Google Analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-28287414-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Pineapple Project</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                              <li class="">
                    <a href="../index.html" title="Pineapple Home">
        Pineapple Home</a>
        </li>
      <li class="divider ">/</li>
        <li class="">How-to: Write code to generate modules</li>
        
                
                    
                  <li id="publishDate" class="pull-right">Last Published: 14 Apr 2017</li> 
            
                            </ul>
      </div>

                  
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Project Overview</li>
                                
      <li>
    
                          <a href="../index.html" title="Home">
          <i class="none"></i>
        Home</a>
            </li>
                  
      <li>
    
                          <a href="../usage/installation.html" title="Installation">
          <i class="none"></i>
        Installation</a>
            </li>
                  
      <li>
    
                          <a href="../usage/index.html" title="For Users">
          <i class="none"></i>
        For Users</a>
            </li>
                  
      <li>
    
                          <a href="../development/index.html" title="For Developers">
          <i class="none"></i>
        For Developers</a>
            </li>
                  
      <li>
    
                          <a href="../usage/terms.html" title="Terms and Conditions">
          <i class="none"></i>
        Terms and Conditions</a>
            </li>
                              <li class="nav-header">Clients</li>
                                
      <li>
    
                          <a href="../pineapple-applications/pineapple-web-application/pineapple-standalone-web-client/index.html" title="Standalone Web Application">
          <i class="none"></i>
        Standalone Web Application</a>
            </li>
                  
      <li>
    
                          <a href="../pineapple-applications/pineapple-web-application/pineapple-web-application-war/index.html" title="Deployable Web Application">
          <i class="none"></i>
        Deployable Web Application</a>
            </li>
                  
      <li>
    
                          <a href="../pineapple-applications/pineapple-maven-plugin/index.html" title="Maven Plugin">
          <i class="none"></i>
        Maven Plugin</a>
            </li>
                              <li class="nav-header">Plugins</li>
                                
      <li>
    
                          <a href="../pineapple-plugins/pineapple-agent-plugin/index.html" title="Agent">
          <i class="none"></i>
        Agent</a>
            </li>
                  
      <li>
    
                          <a href="../pineapple-plugins/pineapple-composite-execution-plugin/index.html" title="Composite Execution">
          <i class="none"></i>
        Composite Execution</a>
            </li>
                  
      <li>
    
                          <a href="../pineapple-plugins/pineapple-ssh-plugin/index.html" title="SSH">
          <i class="none"></i>
        SSH</a>
            </li>
                  
      <li>
    
                          <a href="../pineapple-plugins/pineapple-docker-plugin/index.html" title="Docker">
          <i class="none"></i>
        Docker</a>
            </li>
                  
      <li>
    
                          <a href="../pineapple-modules/pineapple-infrastructure-test-plugin/index.html" title="Infrastructure Test">
          <i class="none"></i>
        Infrastructure Test</a>
            </li>
                  
      <li>
    
                          <a href="../pineapple-plugins/pineapple-fusion-middleware-installation-plugin/index.html" title="Fusion Middleware Installation">
          <i class="none"></i>
        Fusion Middleware Installation</a>
            </li>
                  
      <li>
    
                          <a href="../pineapple-plugins/pineapple-weblogic-installation-plugin/index.html" title="WebLogic Installation">
          <i class="none"></i>
        WebLogic Installation</a>
            </li>
                  
      <li>
    
                          <a href="../pineapple-plugins/pineapple-weblogic-scripting-tool-plugin/index.html" title="WebLogic Scripting Tool (WLST)">
          <i class="none"></i>
        WebLogic Scripting Tool (WLST)</a>
            </li>
                  
      <li>
    
                          <a href="../pineapple-modules/pineapple-weblogic-jmx-plugin/index.html" title="WebLogic JMX">
          <i class="none"></i>
        WebLogic JMX</a>
            </li>
                              <li class="nav-header">API's</li>
                                
      <li>
    
                          <a href="../pineapple-applications/pineapple-web-application/pineapple-web-application-war/usage/rest.html" title="REST">
          <i class="none"></i>
        REST</a>
            </li>
                  
      <li>
    
                          <a href="../development/plugin-framework.html" title="Plugin Framework">
          <i class="none"></i>
        Plugin Framework</a>
            </li>
                              <li class="nav-header">Additional Information</li>
                                
      <li>
    
                          <a href="http://pineapplesoftware.blogspot.com" class="externalLink" title="The Pineapple Project Blog">
          <i class="none"></i>
        The Pineapple Project Blog</a>
            </li>
                  
      <li>
    
                          <a href="http://exceptiontrail.blogspot.com" class="externalLink" title="Pineapple Exception Trail Blog">
          <i class="none"></i>
        Pineapple Exception Trail Blog</a>
            </li>
                              <li class="nav-header">Project Tools</li>
                                
      <li>
    
                          <a href="https://bintray.com/pineapple/maven/com.alpha.pineapple" class="externalLink" title="Downloads">
          <i class="none"></i>
        Downloads</a>
            </li>
                  
      <li>
    
                          <a href="https://github.com/athrane/pineapple" class="externalLink" title="Source Code">
          <i class="none"></i>
        Source Code</a>
            </li>
                  
      <li>
    
                          <a href="https://github.com/athrane/pineapple/issues" class="externalLink" title="Issue Tracker">
          <i class="none"></i>
        Issue Tracker</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                        
      <li>
    
                          <a href="../project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                   
    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>

    
    <div class="g-plusone" data-href="http://pineapple.java.net/" data-size="tall" ></div>

                   <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                        
        <div id="bodyColumn"  class="span10" >
                                  
            <!-- NOTE: For help with the syntax of this file, see: --><!-- http://maven.apache.org/guides/mini/guide-apt-format.html --><div class="section">
<h2>How-to: Write code to generate modules<a name="How-to:_Write_code_to_generate_modules"></a></h2>
<p>To code needed to create a Pineapple module: </p>
<ul>
<li>Generate the module directory</li>
<li>Generate the module file <tt>module.xml</tt> </li>
<li>a <tt>NamespacePrefixMapper</tt></li>
<li>Generate the model file(s) <tt>${env}.xml</tt> </li></ul>
<p>Links:</p>
<ul>
<li><a class="externalLink" href="https://jaxb.dev.java.net/2.1.9/docs/vendorProperties.html">JAXB RI documentation of namespace prefix mapping.</a></li>
<li><a class="externalLink" href="http://blogs.sun.com/enterprisetechtips/entry/customizing_jaxb">How to customize namespace prefix mapping in JAXB.</a></li></ul>
<div class="section">
<h3>Generate the module directory <a name="Generate_the_module_directory"></a></h3>
<p>To create the module directory, invoke:</p>
<div class="source">
<pre>
  // get user.home
  String userHome = System.getProperty( &quot;user.home&quot; );

  // define default pineapple runtime directory
  File runtimeDirectory = new File( userHome, &quot;.pineapple&quot; ); 
         
  // define modules directory
  File modulesDirectory = new File( runtimeDirectory, &quot;modules&quot; ); 

  // define my moduel directory         
  String moduleId = &quot;my-generated-module&quot;;
  File moduleDirectory = new File( modulesDirectory, moduleId );
        
  // create the directory               
  if(!moduleDirectory.exists()) moduleDirectory.mkdirs();
  
</pre></div>
<p>The <tt>pineapple-test-utils&gt;&gt; project contains a utility named &lt;&lt;&lt;ObjectMotherModule</tt> which can be used to create modules. To create the directory, invoke:</p>
<div class="source">
<pre>
  // create the module mother 
  ObjectMotherModule moduleMother = new ObjectMotherModule();

  // create module directory 
  moduleMother.createNullModule( moduleId, moduleDirectory );
  
</pre></div></div>
<div class="section">
<h3>Generate the module file <tt>module.xml</tt><a name="Generate_the_module_file_module.xml"></a></h3>
<p>Pineapple modules are defined in the <b>module schema</b>. The project <tt>pineapple-api</tt> contains JAXB generated classes which are generated from the schema. The module classes are located in the <tt>com.alpha.pineapple.model.module</tt> package.</p>
<p>To create and marshall a module, implement: </p>
<div class="source">
<pre>
  // create module factory
  com.alpha.pineapple.model.module.ObjectFactory moduleFactory;
  moduleFactory = new com.alpha.pineapple.model.module.ObjectFactory();

  // create module object
  moduleFactory = new com.alpha.pineapple.model.module.ObjectFactory();
  Module module = moduleFactory.createModule();         

  // define environment for the module
  String environmentId = &quot;some-test-environment&quot;;

  // add a single environment to the module  
  Environment environment = moduleFactory.createEnvironment();
  environment.setId( environmentId );        
  module.setEnvironments( moduleFactory.createEnvironments() );
  module.getEnvironments().getEnvironment().add( environment );  

  // set file name
  StringBuilder fileName;
  fileName = new StringBuilder();
  fileName.append( moduleDir.getAbsolutePath() );
  fileName.append( File.separatorChar );
  fileName.append( &quot;module.xml&quot; );
            
  // define stream for exception handling
  OutputStream os = null;

  try {
            
    // get package name
    String packageName = Module.class.getPackage().getName();

    // marshall the module
    JAXBContext jaxbContext = JAXBContext.newInstance( packageName );
    Marshaller marshaller = jaxbContext.createMarshaller();
    os = new FileOutputStream( file );
    marshaller.marshal( rootObject, os );
    os.close();
  } catch ( Exception e ) {
    // do exception handling
  } finally {
  
    // close OS
    if ( os != null ) {
      try {
        os.close();
      }
      catch ( IOException e ) {
        // do exception handling      
      }
    }
  }

</pre></div>
<p>Again the <tt>ObjectMotherModule</tt> can help:</p>
<div class="source">
<pre>
  // create module file
  Module module = moduleMother.createModuleObject();
  Environment environment = moduleFactory.createEnvironment();
  environment.setId( environmentId );        
  module.setEnvironments( moduleFactory.createEnvironments() );
  module.getEnvironments().getEnvironment().add( environment );
  moduleMother.addModuleFile( module );
  
</pre></div></div>
<div class="section">
<h3>Implement a <tt>NamespacePrefixMapper</tt><a name="Implement_a_NamespacePrefixMapper"></a></h3>
<p>A model file in a Pineapple module uses minimum two schemas:</p>
<ul>
<li>It uses the <b>module module schema</b> which is defined in the <tt>pineapple-api</tt> project. The project also contains JAXB generated classes which are generated from the schema. The model classes are located in the <tt>com.alpha.pineapple.model.module.model</tt> package. </li>
<li>It uses the schemas from the plugins whose model data it contains. In this example the schema from the infrastructure test plugin will be used. The plugin is located in the project <tt>infrastructure-test-plugin</tt> and it contains the plugin schema, named <tt>infrastructure_1_0.xsd</tt>. The plugin project contains JAXB generated classes which are generated from the schema. The classes are located in the <tt>com.alpha.pineapple.plugin.infrastructure.model</tt> package. </li></ul>
<p>When JAXB marshall the model to an XML file it is recommended that the file is marshalled with the elements prefixed with the their namespaces.</p>
<p>To enable this behavior in JAXB a <tt>NamespacePrefixMapper</tt> must be implemented which:</p>
<ul>
<li>Declares the used name spaces</li>
<li>Defines mappings between each used namespace and a prefix.</li></ul>
<p>In this example these schemas are used:</p>
<ul>
<li><tt>http://pineapple.dev.java.net/ns/module_1_0</tt></li></ul>
<ul>
<li><tt>http://pineapple.dev.java.net/ns/module_model_1_0</tt></li>
<li><tt>http://pineapple.dev.java.net/ns/plugin/infrastructure_1_0</tt></li></ul>
<p>The use prefixes:</p>
<ul>
<li><tt>mdl</tt> for <tt>http://pineapple.dev.java.net/ns/module_1_0</tt></li>
<li><tt>mmd</tt> for <tt>http://pineapple.dev.java.net/ns/module_model_1_0</tt></li>
<li><tt>itp</tt> for <tt>http://pineapple.dev.java.net/ns/plugin/infrastructure_1_0</tt></li></ul>
<p>The implemented mapper class:</p>
<div class="source">
<pre>                
class ModelNamespaceMapper extends NamespacePrefixMapper {

  @Override
  public String[] getPreDeclaredNamespaceUris() {
    return new String[]{ &quot;http://pineapple.dev.java.net/ns/module_1_0&quot;,
                         &quot;http://pineapple.dev.java.net/ns/module_model_1_0&quot;,
                         &quot;http://pineapple.dev.java.net/ns/plugin/infrastructure_1_0&quot; };
    }

  @Override
  public String getPreferredPrefix( String namespaceUri, String arg1, boolean arg2 ) {
    if ( namespaceUri.equals( &quot;http://pineapple.dev.java.net/ns/module_1_0&quot;  )) return  &quot;mdl&quot;;            
    if ( namespaceUri.equals( &quot;http://pineapple.dev.java.net/ns/module_model_1_0&quot;  )) return &quot;mmd&quot;;
    if ( namespaceUri.equals( &quot;http://pineapple.dev.java.net/ns/plugin/infrastructure_1_0&quot;  )) return &quot;itp&quot;;
    return null; // use default namespace
  }
}
                
</pre></div></div>
<div class="section">
<h3>Generate the model file(s) <tt>${env}.xml</tt> <a name="Generate_the_model_files_env.xml"></a></h3>
<p>Three steps are involved in the creating the model file:</p>
<ul>
<li>Creating module model objects </li>
<li>Add test cases from the infrastructure test plugin</li>
<li>Marshal the model to XML file </li></ul>
<div class="section">
<h4>Creating module model objects<a name="Creating_module_model_objects"></a></h4>
<div class="source">
<pre>
  // create model file
  Models models = modelFactory.createModels();
  AggregatedModel aggregatedModel = modelFactory.createAggregatedModel();
  aggregatedModel.setTargetResource( resourceId );
  aggregatedModel.setContent( modelFactory.createContent() );
  models.getModel().add( aggregatedModel );
  
</pre></div></div>
<div class="section">
<h4>Add test cases from the infrastructure test plugin<a name="Add_test_cases_from_the_infrastructure_test_plugin"></a></h4>
<div class="source">
<pre>
  com.alpha.pineapple.plugin.infrastructure.model.ObjectFactory pluginFactory;
  pluginFactory = new com.alpha.pineapple.plugin.infrastructure.model.ObjectFactory();
        
  // create infrastructure model
  Infrastructure infrastruture = pluginFactory.createInfrastructure();        
        
  // resolve to ip test container
  List&lt;ResolveNameToIpTest&gt; resolveToIpTests = infrastruture.getResolveToIpTest();
                
  // create test case
  String host = // get host for test case.                                
  String description = // get description for test case.
  ResolveNameToIpTest resolveIP = pluginFactory.createResolveNameToIpTest();
  resolveIP.setDescription(description);
  resolveIP.setHost( host );
  ResolveNameToIpAssertionValues assertValues = pluginFactory.createResolveNameToIpAssertionValues();
  assertValues.setIp( host );
  resolveIP.setAssert( assertValues );
                
  // add test to container
  resolveToIpTests.add( resolveIP );                                                 

</pre></div></div>
<div class="section">
<h4>Marshal the model to XML file <a name="Marshal_the_model_to_XML_file"></a></h4>
<p>The marshalling is done in two steps. First the objects from the intrastructure test plugin is marshalled into a DOM document.</p>
<p>Then the DOM document is then inserted into the model. </p>
<p>The reason for the intermediate marshalling to DOM is caused by the usage of the <b>any</b> type in the module model schema. The resulting JAXB classes represents the <tt>any</tt> type as a list of <tt>org.w3c.dom.Element</tt>, so it is needed to convert the infrastructure objects to something that can be inserted as DOM Elements.</p>
<p>Marshalling the infrastructures object to DOM, using the prefix mapper: </p>
<div class="source">
<pre>  
  // get package name
  String packageName = Infrastructure.class.getPackage().getName();  

  // create the prefix mapper
  NamespacePrefixMapper prefixMapper = new ModelNamespaceMapper()
        
  // create JAXB context   
  JAXBContext jaxbContext = JAXBContext.newInstance( packageName );
  
  // create marsahller with mapper  
  Marshaller marshaller = jaxbContext.createMarshaller();
  marshaller.setProperty( &quot;com.sun.xml.bind.namespacePrefixMapper&quot;, mapper );
        
  // create DOM document
  DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
  dbf.setNamespaceAware(true);
  DocumentBuilder db = dbf.newDocumentBuilder();
  Document doc = db.newDocument();
  
  // marshall  JAXB object into DOM document          
  marshaller.marshal( rootObject, doc );
  
</pre></div>
<p>Then the DOM document is added to the model object:</p>
<div class="source">
<pre>
  // get content root
  Content contentRoot = aggregatedModel.getContent();
                
  // add test cases from infrastructure model to aggregated model 
  // Any is defined with processContents=&quot;skip&quot; which maps to org.w3c.dom.Element or List&lt;Element&gt;
  List&lt;Element&gt; domElements = contentRoot.getAny();                        
  domElements.add( (Element) doc.getDocumentElement() );
  
</pre></div>
<p>Finally, the model is marshalled to XML:</p>
<div class="source">
<pre>
  // define the models directory in the module  
  File modelsDirectory = new File( modulesDirectory, &quot;models&quot; );

  // create the directory               
  if(!modelsDirectory.exists()) modelsDirectory.mkdirs();

  // set file name
  StringBuilder fileName;
  fileName = new StringBuilder();
  fileName.append( environmentId );
  fileName.append( &quot;.xml&quot; );

  // create models file object 
  File modelFile = new File (modelsDirectory, fileName.toString());            

  // define stream for exception handling
  OutputStream os = null;

  try {
            
    // get package name
    String packageName = Models.class.getPackage().getName();

    // marshall the model 
    JAXBContext jaxbContext = JAXBContext.newInstance( packageName );
    Marshaller marshaller = jaxbContext.createMarshaller();
    os = new FileOutputStream( file );
    marshaller.marshal( rootObject, os );
    os.close();
  } catch ( Exception e ) {
    // do exception handling
  } finally {
  
    // close OS
    if ( os != null ) {
      try {
        os.close();
      }
      catch ( IOException e ) {
        // do exception handling      
      }
    }
  }
    
</pre></div>
<p>Again the <tt>ObjectMotherModule</tt> can help:</p>
<div class="source">
<pre>
  // marshal model 
  moduleMother.addModelFile( environmentId, models );
    
</pre></div></div></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                   2017.
          All Rights Reserved.      
                    
      </div>

                          
        
                </div>
    </footer>
  </body>
</html>
