<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 30 Mar 2018
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Allan Thrane Andersen" />
    <meta name="Date-Revision-yyyymmdd" content="20180330" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Pineapple SSH plugin - How-to: Install Jenkins and Artifactory in a Linux Vagrant box using SSH</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />

      
    <script type="text/javascript" src="../js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Pineapple SSH plugin</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                              <li class="">
                    <a href="../../../index.html" title="Pineapple Home">
        Pineapple Home</a>
        </li>
      <li class="divider ">/</li>
            <li class="">
                    <a href="../../" title="Pineapple plugin projects">
        Pineapple plugin projects</a>
        </li>
      <li class="divider ">/</li>
            <li class="">
                    <a href="../" title="Pineapple SSH plugin">
        Pineapple SSH plugin</a>
        </li>
      <li class="divider ">/</li>
        <li class="">How-to: Install Jenkins and Artifactory in a Linux Vagrant box using SSH</li>
        
                
                    
                  <li id="publishDate" class="pull-right">Last Published: 30 Mar 2018</li> 
            
                            </ul>
      </div>

                  
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Project Overview</li>
                                
      <li>
    
                          <a href="../../../index.html" title="Home">
          <i class="none"></i>
        Home</a>
            </li>
                  
      <li>
    
                          <a href="../../../usage/installation.html" title="Installation">
          <i class="none"></i>
        Installation</a>
            </li>
                  
      <li>
    
                          <a href="../../../usage/index.html" title="For Users">
          <i class="none"></i>
        For Users</a>
            </li>
                  
      <li>
    
                          <a href="../../../development/index.html" title="For Developers">
          <i class="none"></i>
        For Developers</a>
            </li>
                  
      <li>
    
                          <a href="../../../usage/terms.html" title="Terms and Conditions">
          <i class="none"></i>
        Terms and Conditions</a>
            </li>
                              <li class="nav-header">Clients</li>
                                
      <li>
    
                          <a href="../../../pineapple-applications/pineapple-web-application/pineapple-standalone-web-client/index.html" title="Standalone Web Application">
          <i class="none"></i>
        Standalone Web Application</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-applications/pineapple-web-application/pineapple-web-application-war/index.html" title="Deployable Web Application">
          <i class="none"></i>
        Deployable Web Application</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-applications/pineapple-maven-plugin/index.html" title="Maven Plugin">
          <i class="none"></i>
        Maven Plugin</a>
            </li>
                              <li class="nav-header">Plugins</li>
                                
      <li>
    
                          <a href="../../../pineapple-plugins/pineapple-agent-plugin/index.html" title="Agent">
          <i class="none"></i>
        Agent</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-plugins/pineapple-composite-execution-plugin/index.html" title="Composite Execution">
          <i class="none"></i>
        Composite Execution</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-plugins/pineapple-ssh-plugin/index.html" title="SSH">
          <i class="none"></i>
        SSH</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-plugins/pineapple-docker-plugin/index.html" title="Docker">
          <i class="none"></i>
        Docker</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-modules/pineapple-infrastructure-test-plugin/index.html" title="Infrastructure Test">
          <i class="none"></i>
        Infrastructure Test</a>
            </li>
                              <li class="nav-header">API's</li>
                                
      <li>
    
                          <a href="../../../pineapple-applications/pineapple-web-application/pineapple-web-application-war/usage/rest.html" title="REST">
          <i class="none"></i>
        REST</a>
            </li>
                  
      <li>
    
                          <a href="../../../development/plugin-framework.html" title="Plugin Framework">
          <i class="none"></i>
        Plugin Framework</a>
            </li>
                              <li class="nav-header">Additional Information</li>
                                
      <li>
    
                          <a href="http://pineapplesoftware.blogspot.com" class="externalLink" title="The Pineapple Project Blog">
          <i class="none"></i>
        The Pineapple Project Blog</a>
            </li>
                  
      <li>
    
                          <a href="http://exceptiontrail.blogspot.com" class="externalLink" title="Pineapple Exception Trail Blog">
          <i class="none"></i>
        Pineapple Exception Trail Blog</a>
            </li>
                              <li class="nav-header">Project Tools</li>
                                
      <li>
    
                          <a href="https://bintray.com/pineapple/maven/com.alpha.pineapple" class="externalLink" title="Downloads">
          <i class="none"></i>
        Downloads</a>
            </li>
                  
      <li>
    
                          <a href="https://github.com/athrane/pineapple" class="externalLink" title="Source Code">
          <i class="none"></i>
        Source Code</a>
            </li>
                  
      <li>
    
                          <a href="https://github.com/athrane/pineapple/issues" class="externalLink" title="Issue Tracker">
          <i class="none"></i>
        Issue Tracker</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                        
      <li>
    
                          <a href="../project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                   
    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>

    
    <div class="g-plusone" data-href="https://pineapple.java.net" data-size="tall" ></div>

                   <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                        
        <div id="bodyColumn"  class="span10" >
                                  
            <!-- NOTE: For help with the syntax of this file, see: --><!-- http://maven.apache.org/guides/mini/guide-apt-format.html --><div class="section">
<h2>How-to: Install Jenkins and Artifactory in a Linux Vagrant box using SSH<a name="How-to:_Install_Jenkins_and_Artifactory_in_a_Linux_Vagrant_box_using_SSH"></a></h2>
<div class="section">
<h3>Overview<a name="Overview"></a></h3>
<p>This example illustrates how the SSH plugin can be used to install Jenkins and Artifactory on Linux (CentOS and Red Hat). The example integrates Jenkins with artifactory and creates a build job. </p>
<p>Two steps are required to install Jenkins and Artifactory:</p>
<ul>
<li>Create a VM which serves as build server. Vagrant is used for this purpose.</li>
<li>Start Pineapple and execute the module.</li>
<li>(When the installation is completed, start the created build job at Jenkins.) </li></ul>
<div class="section">
<h4>Part of the default configuration<a name="Part_of_the_default_configuration"></a></h4>
<p>This example named <tt>ssh-010-ssh-install-jenkins-artifactory</tt>, including all configuration files, is included in the <a href="../../../usage/default-configuration.html">default configuration</a> which is created by Pineapple, so there is no need to create it by hand.</p></div></div>
<div class="section">
<h3>The steps<a name="The_steps"></a></h3>
<div class="section">
<h4>Build a Vagrant box<a name="Build_a_Vagrant_box"></a></h4>
<ol style="list-style-type: decimal">
<li>Install VirtualBox and Vagrant.</li>
<li>Create a Vagrant project directory <tt>jenkins-ci</tt>.</li>
<li>Copy the example Vagrant configuration file from <i>${user.home}/.pineapple/modules/ssh-010-ssh-install-jenkins-artifactory/vagrant/Vagrantfile</i> directory to the Vagrant project directory: 
<div class="source">
<pre># -*- mode: ruby -*-
# vi: set ft=ruby :

BOX_NAME = ENV.fetch(&quot;BOX_NAME&quot;, &quot;pineapple-box&quot;) 
BOX_URI = ENV.fetch(&quot;BOX_URI&quot;, &quot;http://puppet-vagrant-boxes.puppetlabs.com/centos-65-x64-virtualbox-puppet.box&quot;) 
BOX_IP = ENV.fetch(&quot;BOX_IP&quot;, &quot;192.168.34.10&quot;) 
BOX_MEM = ENV.fetch(&quot;BOX_MEM&quot;, &quot;2048&quot;) 
BOX_CPUS = ENV.fetch(&quot;BOX_CPUS&quot;, &quot;2&quot;) 

VAGRANTFILE_API_VERSION = &quot;2&quot;

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

        # virtual box provider specific settings
        config.vm.provider :virtualbox do |vb|                                  
                vb.customize [&quot;modifyvm&quot;, :id, &quot;--ioapic&quot;, &quot;on&quot;]    
                vb.customize [&quot;modifyvm&quot;, :id, &quot;--memory&quot;, BOX_MEM]    
                vb.customize [&quot;modifyvm&quot;, :id, &quot;--cpus&quot;, BOX_CPUS]      
        end     

        config.vm.define :pineapple_ci do |ci_config|
                ci_config.vm.box = BOX_NAME    
                ci_config.vm.box_url = BOX_URI    
                ci_config.vm.network &quot;private_network&quot;, ip: BOX_IP      
        end
                
end     
</pre></div></li>
<li>Open a prompt, CD into the Vagrant project directory and create the box with the command: <tt>vagrant up</tt>. It will download a CentOS 6.5 image and start the VM with the IP address 192.168.34.10.</li></ol></div>
<div class="section">
<h4>Invoke Pineapple to install Jenkins<a name="Invoke_Pineapple_to_install_Jenkins"></a></h4>
<p>Start your Pineapple client of choice:</p>
<ol style="list-style-type: decimal">
<li>Select the module named <b>ssh-010-ssh-install-jenkins-artifactory</b></li>
<li>Select the <b>linux-vagrant</b> model.</li>
<li>Invoke the <b>deploy-configuration</b> operation to install Jenkins. </li></ol></div>
<div class="section">
<h4>Start the build job<a name="Start_the_build_job"></a></h4>
<ol style="list-style-type: decimal">
<li>Access Jenkins at: http://192.168.34.10:8080</li>
<li>Select the installed job <i>pineapple-build</i> and build it. The build will but it is an example.</li></ol>
<p>Artifactory listens on http://192.168.34.10:8081 </p></div></div>
<div class="section">
<h3>The details<a name="The_details"></a></h3>
<p>The details of the module, model and the Pineapple resources are described in the following sections.</p>
<div class="section">
<h4>The resources<a name="The_resources"></a></h4>
<p>A resource defines a entity in a IT environment which is manageable by Pineapple through some protocol. In this example, the entity is a Linux OS and the used protocol is SSH. One resource is defined for each Linux host where the YUM packages should be installed.</p>
<p>In this example we will use the <tt>linux-vagrant</tt> environment defined as part of the default configuration. The environment defines a network with three hosts: </p>
<ul>
<li><i>Node1</i> with IP Address: 192.168.34.10</li>
<li><i>Node2</i> with IP Address: 192.168.34.11</li>
<li><i>Node3</i> with IP Address: 192.168.34.12</li></ul>
<p>To enable SSH usage for these hosts, three resources are defined within the <tt>linux-vagrant</tt> environment in the resources file located at <tt>${user.home}/.pineapple/conf/resources.xml</tt>: </p>
<div class="source">
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;configuration xmlns=&quot;http://pineapple.dev.java.net/ns/environment_1_0&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://pineapple.dev.java.net/ns/environment_1_0
    http://pineapple.dev.java.net/ns/environment_1_0.xsd&quot;&gt;
     
    &lt;environments&gt;
        &lt;environment description=&quot;Vagrant multi-machine Linux environment&quot; id=&quot;linux-vagrant&quot;&gt;
            &lt;resources&gt;
                &lt;resource plugin-id=&quot;com.alpha.pineapple.plugin.ssh&quot; credential-id-ref=&quot;ssh-node1&quot; id=&quot;ssh-node1&quot; &gt;
                    &lt;property value=&quot;192.168.34.10&quot; key=&quot;host&quot;/&gt;
                    &lt;property value=&quot;22&quot; key=&quot;port&quot;/&gt;
                    &lt;property value=&quot;1000&quot; key=&quot;timeout&quot;/&gt;
                &lt;/resource&gt;
                &lt;resource plugin-id=&quot;com.alpha.pineapple.plugin.ssh&quot; credential-id-ref=&quot;ssh-node2&quot; id=&quot;ssh-node2&quot; &gt;
                    &lt;property value=&quot;192.168.34.11&quot; key=&quot;host&quot;/&gt;
                    &lt;property value=&quot;22&quot; key=&quot;port&quot;/&gt;
                    &lt;property value=&quot;1000&quot; key=&quot;timeout&quot;/&gt;
                &lt;/resource&gt;
                &lt;resource plugin-id=&quot;com.alpha.pineapple.plugin.ssh&quot; credential-id-ref=&quot;ssh-node3&quot; id=&quot;ssh-node3&quot; &gt;
                    &lt;property value=&quot;192.168.34.12&quot; key=&quot;host&quot;/&gt;
                    &lt;property value=&quot;22&quot; key=&quot;port&quot;/&gt;
                    &lt;property value=&quot;1000&quot; key=&quot;timeout&quot;/&gt;
                &lt;/resource&gt;
            &lt;/resources&gt;
        &lt;/environment&gt;
    &lt;/environments&gt;
&lt;/configuration&gt; 
</pre></div>
<p>Each resource is defined with a different ID and IP address. All other properties are identical. The role of the attribute <tt>plugin-id</tt> is to bind the resource definition to the plugin code at runtime which implements the SSH plugin.</p>
<p><b>Please notice:</b> Only the VM for <tt>ssh-node1</tt> is created by Vagrant. Even though the <tt>linux-vagrant</tt> environment defines three resource, only the <tt>ssh-node1</tt> resource is used in the example. </p></div>
<div class="section">
<h4>The credentials<a name="The_credentials"></a></h4>
<p>Since SSH requires authentication, each resource defines a reference to a credential. A credential defines the user name and password used for authentication when a SSH session is created to a host.</p>
<p>Three credentials are created within the <tt>linux-vagrant</tt> environment to support authentication. The credentials are defined in the credentials file located at <tt>${user.home}/.pineapple/conf/credentials.xml</tt>: </p>
<div class="source">
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;
&lt;configuration xmlns=&quot;http://pineapple.dev.java.net/ns/environment_1_0&quot;&gt;
    &lt;environments&gt;
        &lt;environment description=&quot;Vagrant multi-machine Linux environment&quot; id=&quot;linux-vagrant&quot;&gt;
            &lt;credentials&gt;
                &lt;credential password=&quot;vagrant&quot; user=&quot;vagrant&quot; id=&quot;ssh-node1&quot;/&gt;
                &lt;credential password=&quot;vagrant&quot; user=&quot;vagrant&quot; id=&quot;ssh-node2&quot;/&gt;
                &lt;credential password=&quot;vagrant&quot; user=&quot;vagrant&quot; id=&quot;ssh-node3&quot;/&gt;
            &lt;/credentials&gt;
        &lt;/environment&gt;
    &lt;/environments&gt;     
&lt;/configuration&gt;
</pre></div>
<p><b>Please notice:</b> Only the VM for <tt>ssh-node1</tt> is created by Vagrant. Even though the <tt>linux-vagrant</tt> environment defines three credentials, only the <tt>ssh-node1</tt> credential is used in the example. </p></div>
<div class="section">
<h4>The module <a name="The_module"></a></h4>
<p>A module defines input to Pineapple and consists in its minimal form of a single XML file containing a model:</p><img src="../images/module-directory-layout.jpg" alt="" />
<p>The directory: <tt>${user.home}/.pineapple/modules/ssh-010-ssh-install-jenkins-artifactory</tt> contains the module. The module in this example have the structure:</p>
<div class="source">
<pre>ssh-010-ssh-install-jenkins-artifactory
 |
 +--- bin        
 |     +--- artifactory.config.xml
 |     +--- artifactory.repo
 |     +--- config.xml
 |     +--- hudson.tasks.Maven.xml 
 |     +--- pineapple-build.config.xml
 |     +--- settings.xml
 |     +--- weblogic-full-client-12.1.2.jar.ADD-HERE
 |
 +--- models     
 |     +--- linux-vagrant.xml
 +--- vagrant    
 |     +--- Vagrantfile
</pre></div></div>
<div class="section">
<h4>Module files<a name="Module_files"></a></h4>
<p>The module consists of the these files:</p>
<ul>
<li><tt>artifactory.config.xml</tt> is the main Artifactory configuration file. It is installed in Artifactory using a web service. </li>
<li><tt>artifactory.repo</tt> is a YUM configuration file. It is installed at <tt>/etc/yum.repos.d/artifactory.repo</tt>. It defines where the Artifactory RPM packages can downloaded from.</li>
<li><tt>config.xml</tt> is the main Jenkins configuration file which is installed at <tt>/var/lib/jenkins/config.xml</tt>. It defines the path to OpenJDK used for compiling build job.</li>
<li><tt>hudson.tasks.Maven.xml</tt> is Jenkins Maven configuration which is installed at <tt>/var/lib/jenkins/hudson.tasks.Maven.xml</tt>. It the version of Maven to be installed and used by Jenkins for build jobs. </li>
<li><tt>pineapple-build.config.xml</tt> is a build job named <i>pineapple-build</i> which is installed at <tt>/var/lib/jenkins/jobs/pineapple-build</tt>.</li>
<li><tt>settings.xml</tt> is a Maven configuration file used to configure Maven for specific build jobs. It is installed at <tt>/var/lib/jenkins/settings.xml</tt>. </li>
<li><tt>linux-vagrant.xml</tt> is the Pineapple model file for the environment <i>linux-vagrant</i> which installs Jenkins.</li>
<li><tt>Vagrantfile</tt> is a Vagrant file which can build the VM where Jenkins is installed.</li></ul></div>
<div class="section">
<h4>The model file<a name="The_model_file"></a></h4>
<p>The model file named <tt>linux-vagrant.xml</tt> has the content:</p>
<div class="source">
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;
&lt;mmd:models xmlns:mmd=&quot;http://pineapple.dev.java.net/ns/module_model_1_0&quot;     
  xmlns:shp=&quot;http://pineapple.dev.java.net/ns/plugin/ssh_1_0&quot; &gt;
    &lt;mmd:variables&gt;
      &lt;mmd:variable key=&quot;tmp-dir&quot; value=&quot;/tmp&quot; /&gt;       
      &lt;mmd:variable key=&quot;base-jdk&quot; value=&quot;java-1.7.0-openjdk-devel&quot; /&gt;
      &lt;!-- continous integration server variables --&gt;   
      &lt;mmd:variable key=&quot;ci-usergroup&quot; value=&quot;jenkins:jenkins&quot; /&gt;
      &lt;mmd:variable key=&quot;ci-home&quot; value=&quot;/var/lib/jenkins&quot; /&gt;
      &lt;mmd:variable key=&quot;ci-jobs-home&quot; value=&quot;/var/lib/jenkins/jobs&quot; /&gt;
      &lt;mmd:variable key=&quot;ci-config&quot; value=&quot;config.xml&quot; /&gt;
      &lt;mmd:variable key=&quot;ci-maven-config&quot; value=&quot;hudson.tasks.Maven.xml&quot; /&gt;
      &lt;mmd:variable key=&quot;ci-job&quot; value=&quot;pineapple-build&quot; /&gt;
      &lt;mmd:variable key=&quot;ci-job-source-config&quot; value=&quot;pineapple-build.config.xml&quot; /&gt;
      &lt;!-- continous integration Maven  variables --&gt;   
      &lt;mmd:variable key=&quot;maven-config&quot; value=&quot;settings.xml&quot; /&gt;
      &lt;!-- repository manager variables --&gt;   
      &lt;mmd:variable key=&quot;rm-repo-config&quot; value=&quot;artifactory.repo&quot; /&gt;        
      &lt;mmd:variable key=&quot;rm-config&quot; value=&quot;artifactory.config.xml&quot; /&gt;        
      &lt;mmd:variable key=&quot;rm-user&quot; value=&quot;admin&quot; /&gt;        
      &lt;mmd:variable key=&quot;rm-pwd&quot; value=&quot;password&quot; /&gt;        
      &lt;mmd:variable key=&quot;rm-port&quot; value=&quot;8081&quot; /&gt;        
      &lt;mmd:variable key=&quot;rm-ws-upload-system-config&quot; value=&quot;/artifactory/api/system/configuration&quot; /&gt;        
      &lt;mmd:variable key=&quot;rm-ws-upload-artifact&quot; value=&quot;/artifactory/libs-release-local&quot; /&gt;        

      &lt;!-- 3rd party libraries variables --&gt;
      &lt;mmd:variable key=&quot;weblogic-client-1212-jar&quot; value=&quot;weblogic-full-client-12.1.2.jar&quot; /&gt;
      &lt;mmd:variable key=&quot;wbem-102-jar&quot; value=&quot;wbemservices-1.0.2.jar&quot; /&gt;    
    &lt;/mmd:variables&gt;    

    &lt;mmd:model target-resource=&quot;ssh-node1&quot; target-operation=&quot;deploy-configuration&quot; description=&quot;Install JVM&quot; &gt;
      &lt;mmd:content&gt;
        &lt;shp:ssh&gt;
          &lt;shp:execute command=&quot;sudo sudo yum --assumeyes install ${base-jdk}&quot; /&gt;
        &lt;/shp:ssh&gt;      
      &lt;/mmd:content&gt;
    &lt;/mmd:model&gt;
    
    &lt;mmd:model target-resource=&quot;ssh-node1&quot; target-operation=&quot;deploy-configuration&quot; description=&quot;Configure Artifactory package repository&quot; &gt;
      &lt;mmd:content&gt;
        &lt;shp:ssh&gt;
          &lt;shp:copy-to source=&quot;modulepath:bin/${rm-repo-config}&quot; destination=&quot;${tmp-dir}/${rm-repo-config}&quot;/&gt;
          &lt;shp:execute command=&quot;sudo mv ${tmp-dir}/${rm-repo-config} /etc/yum.repos.d/${rm-repo-config}&quot; /&gt;
        &lt;/shp:ssh&gt;      
      &lt;/mmd:content&gt;
    &lt;/mmd:model&gt;    
    &lt;mmd:model target-resource=&quot;ssh-node1&quot; target-operation=&quot;deploy-configuration&quot; description=&quot;Install Artifactory package&quot; &gt;
      &lt;mmd:content&gt;
        &lt;shp:ssh&gt;
          &lt;shp:execute command=&quot;sudo yum --assumeyes install artifactory&quot; /&gt;        
        &lt;/shp:ssh&gt;      
      &lt;/mmd:content&gt;
    &lt;/mmd:model&gt;  
    &lt;mmd:model target-resource=&quot;ssh-node1&quot; target-operation=&quot;deploy-configuration&quot; description=&quot;Start Artifactory&quot; &gt;
      &lt;mmd:content&gt;
        &lt;shp:ssh&gt;
          &lt;shp:execute command=&quot;sudo service artifactory start&quot; /&gt;            
        &lt;/shp:ssh&gt;      
      &lt;/mmd:content&gt;
    &lt;/mmd:model&gt;    
    &lt;mmd:model target-resource=&quot;ssh-node1&quot; target-operation=&quot;deploy-configuration&quot; description=&quot;Invoke Artifactory Web service to trigger initialization&quot; &gt;
      &lt;mmd:content&gt;
        &lt;shp:ssh&gt;
          &lt;shp:execute command=&quot;curl -u ${rm-user}:${rm-pwd} -X GET http://${resource.host}:${rm-port}/api/system/configuration&quot; /&gt;            
        &lt;/shp:ssh&gt;      
      &lt;/mmd:content&gt;
    &lt;/mmd:model&gt;    
        
    &lt;mmd:model target-resource=&quot;ssh-node1&quot; target-operation=&quot;deploy-configuration&quot; description=&quot;Install Jenkins packages&quot; &gt;
      &lt;mmd:content&gt;
        &lt;shp:ssh&gt;
          &lt;shp:execute command=&quot;sudo wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.repo&quot; /&gt;
          &lt;shp:execute command=&quot;sudo rpm --import http://pkg.jenkins-ci.org/redhat/jenkins-ci.org.key&quot; /&gt;
          &lt;shp:execute command=&quot;sudo yum --assumeyes install jenkins&quot; /&gt;        
        &lt;/shp:ssh&gt;      
      &lt;/mmd:content&gt;
    &lt;/mmd:model&gt;  
    &lt;mmd:model target-resource=&quot;ssh-node1&quot; target-operation=&quot;deploy-configuration&quot; description=&quot;Install Jenkins job files&quot; &gt;
      &lt;mmd:content&gt;
        &lt;shp:ssh&gt;
          &lt;!-- install Jenkins main configuration file --&gt;
          &lt;shp:copy-to source=&quot;modulepath:bin/${ci-config}&quot; destination=&quot;${tmp-dir}/${ci-config}&quot; chmod=&quot;775&quot; /&gt;        
          &lt;shp:execute command=&quot;sudo chown ${ci-usergroup} ${tmp-dir}/${ci-config}&quot; /&gt;                
          &lt;shp:execute command=&quot;sudo mv ${tmp-dir}/${ci-config} ${ci-home}/${ci-config}&quot; /&gt;               

          &lt;!-- install Jenkins Maven configuration file --&gt;
          &lt;shp:copy-to source=&quot;modulepath:bin/${ci-maven-config}&quot; destination=&quot;${tmp-dir}/${ci-maven-config}&quot; chmod=&quot;775&quot; /&gt;
          &lt;shp:execute command=&quot;sudo chown ${ci-usergroup} ${tmp-dir}/${ci-maven-config}&quot; /&gt;                
          &lt;shp:execute command=&quot;sudo mv ${tmp-dir}/${ci-maven-config} ${ci-home}/${ci-maven-config}&quot; /&gt;               

          &lt;!-- install Jenkins Maven settings.xml file for builds --&gt;
          &lt;shp:copy-to source=&quot;modulepath:bin/${maven-config}&quot; destination=&quot;${tmp-dir}/${maven-config}&quot; chmod=&quot;775&quot; /&gt;        
          &lt;shp:execute command=&quot;sudo chown ${ci-usergroup} ${tmp-dir}/${maven-config}&quot; /&gt;               
          &lt;shp:execute command=&quot;sudo mv ${tmp-dir}/${maven-config} ${ci-home}/${maven-config}&quot; /&gt;               

          &lt;!-- install Jenkins build job --&gt;
          &lt;shp:execute command=&quot;sudo mkdir -p ${ci-jobs-home}/${ci-job}&quot; /&gt;         
          &lt;shp:execute command=&quot;sudo chmod -R 775 ${ci-jobs-home}/${ci-job}&quot; /&gt;       
          &lt;shp:execute command=&quot;sudo chown -R ${ci-usergroup} ${ci-jobs-home}/${ci-job}&quot; /&gt;                       
          &lt;shp:copy-to source=&quot;modulepath:bin/${ci-job-source-config}&quot; destination=&quot;${tmp-dir}/${ci-job-source-config}&quot; chmod=&quot;775&quot; /&gt;
          &lt;shp:execute command=&quot;sudo chown ${ci-usergroup} ${tmp-dir}/${ci-job-source-config}&quot; /&gt;               
          &lt;shp:execute command=&quot;sudo mv ${tmp-dir}/${ci-job-source-config} ${ci-jobs-home}/${ci-job}/${ci-job-target-config}&quot; /&gt;                
        &lt;/shp:ssh&gt;      
      &lt;/mmd:content&gt;
    &lt;/mmd:model&gt;
    &lt;mmd:model target-resource=&quot;ssh-node1&quot; target-operation=&quot;deploy-configuration&quot; description=&quot;Start Jenkins&quot; &gt;
      &lt;mmd:content&gt;
        &lt;shp:ssh&gt;
          &lt;shp:execute command=&quot;sudo service jenkins start&quot; /&gt;            
        &lt;/shp:ssh&gt;      
      &lt;/mmd:content&gt;
    &lt;/mmd:model&gt;  

    &lt;mmd:model target-resource=&quot;ssh-node1&quot; target-operation=&quot;deploy-configuration&quot; description=&quot;Delayed installation of Artifactory configuration and artifacts&quot; &gt;
      &lt;mmd:content&gt;
      &lt;shp:ssh&gt;

        &lt;!-- install Artifactory system configuration --&gt;
        &lt;shp:copy-to source=&quot;modulepath:bin/${rm-config}&quot; destination=&quot;${tmp-dir}/${rm-config}&quot; chmod=&quot;775&quot; /&gt;
          &lt;shp:execute command=&quot;curl -u ${rm-user}:${rm-pwd} -X POST -H &amp;quot;Content-type:application/xml&amp;quot; --data-binary @${tmp-dir}/${rm-config} http://${resource.host}:${rm-port}${rm-ws-upload-system-config}&quot; /&gt;            
          &lt;shp:execute command=&quot;rm -f ${tmp-dir}/${rm-config}&quot; /&gt;            

        &lt;!-- deploy Pineapple 3rd party libraries --&gt;
        &lt;shp:copy-to source=&quot;modulepath:bin/${weblogic-client-1212-jar}&quot; destination=&quot;${tmp-dir}/${weblogic-client-1212-jar}&quot; substitute-variables=&quot;false&quot; chmod=&quot;775&quot; /&gt;
          &lt;shp:execute command=&quot;curl -u ${rm-user}:${rm-pwd} -X PUT  -T ${tmp-dir}/${weblogic-client-1212-jar} http://${resource.host}:${rm-port}${rm-ws-upload-artifact}/oracle/weblogic-full-client/12.1.2/${weblogic-client-1212-jar}&quot; /&gt;            
          &lt;shp:execute command=&quot;rm -f ${tmp-dir}/${weblogic-client-1212-jar}&quot; /&gt;            
        &lt;/shp:ssh&gt;      
        &lt;/mmd:content&gt;
    &lt;/mmd:model&gt;    
&lt;/mmd:models&gt;
</pre></div>
<div class="section">
<h5>The configuration details<a name="The_configuration_details"></a></h5>
<p>Two schema are used in the model file. The <tt>http://pineapple.dev.java.net/ns/module_model_1_0</tt> is used to define the namespace <tt>mmd</tt> which defines the general infrastructure for models. The <tt>http://pineapple.dev.java.net/ns/plugin/ssh_1_0</tt> schema is used to define the namespace <tt>shp</tt> which is used to define the model for the SSH plugin. Since multiple schemas are used to define the model file, the elements are qualified.</p>
<p>Initially in the model a set of variables are defined within the <tt>variables</tt> stanza. The variables are referenced from the remaining part of the model file. </p>
<p>The <tt>target-resource</tt> attribute defines a reference to the resource which is targeted when the model executed. In this case, the value <tt>ssh-node1</tt> targets the model to a single resource. The two other nodes in the <tt>linux-vagrant</tt> environment isn't used in this example. </p>
<p>The model file is divided into five sub-models, which performs the tasks:</p>
<ul>
<li><b>Install JVM</b>. The OpenJDK 1.7.0 package is installed. The package with the postfix &quot;devel&quot; is installed to get the JDK and not just the JRE. The JDK is used from build jobs in Jenkins. An alternative would be to configure Jenkins to download the JDK from Oracle. Oracle downloads require authentication which is avoided when using the OpenJDK. </li>
<li><b>Configure Artifactory package repository</b>. The installation of Artifactory is prepared by installing the file YUM repo file <tt>/etc/yum.repos.d/artifactory.repo</tt> which defines where the Artifactory RPM packages can downloaded from. The property <tt>gpgcheck</tt> is set to zero to disable checksum validation since the Artifactory package fails checksum validation.</li>
<li><b>Install Artifactory package</b>&gt;. YUM is used to install Artifactory as an OS service.</li>
<li><b>Start Artifactory</b>. Starts Artifactory as an OS service.</li>
<li><b>Invoke Artifactory web service to trigger initialization</b>. A Artifactory web service is invoked to trigger initialization. While Artifactory is initializaing, then Jenkins is installed.</li>
<li><b>Install Jenkins packages</b>. The Jenkins package repository is added to the local YUM configuration. YUM is used to install Jenkins as an OS service.</li>
<li><b>Install Jenkins job files</b>. Installation of the Jenkins files consists of four steps:
<ul>
<li>The main Jenkins configuration file <tt>config.xml</tt> is installed on the server in the Jenkins configuration directory at <tt>/var/lib/jenkins</tt>. </li>
<li>The Jenkins Maven configuration file <tt>hudson.tasks.Maven.xml</tt> is installed in <tt>/var/lib/jenkins</tt>. </li>
<li>The Jenkins Maven <tt>settings.xml</tt> file used by builds is installed in <tt>/var/lib/jenkins</tt>.</li>
<li>A build job named <i>build-pineapple</i> is installed in <tt>/var/lib/jenkins/jobs</tt>.</li></ul></li>
<li><b>Start Jenkins</b>. Starts Jenkins as an OS service.</li>
<li><b>Delayed installation of Artifactory configuration and artifacts</b>. By now Artifactory is initialized and it is configured using its REST API.</li></ul>
<p>The <tt>target-operation</tt> attribute is used to restrict that the sub-models are only executed when Pineapple is invoked with the <i>deploy-configuration</i> operation. This allows for the definition of a set of sub-models which only responds to the <i>undeploy-configuration</i> which implements the inverse semantics, e.g. uninstallation of Jenkins from the target server. </p>
<p>Finally, the execute commands in the models is executed using sudo. The requirement for sudo depends on the privileges of the user used by the SSH plugin to connect to a given host. The users was defined in credentials file in the previous section.</p></div></div>
<div class="section">
<h4>Integration between Jenkins and Artifactory<a name="Integration_between_Jenkins_and_Artifactory"></a></h4>
<div class="section">
<h5>Artifactory configuration<a name="Artifactory_configuration"></a></h5>
<p>When Artifactory is initialized then it is configured using its REST API. The configuration uploads a source system configuration. The system configuration defines:</p>
<ul>
<li>The local repository <b>libs-release-local</b> which can be used to store 3rd party libraries which isn't available in any of the public Maven repositories.</li>
<li>An example remote repository <b>zk-ce</b> which holds the publicly available ZK artifacts. The repository defines the URL: http://mavensync.zkoss.org/maven2.</li>
<li>Another example repository <b>zk-ee</b> which holds the ZK enterprise artifacts which requires a ZK enterprise license. The repository defines the URL: http://mavensync.zkoss.org/zk/ee-eval.</li></ul>
<p>The source system configuration file <tt>artifactory.config.xml</tt> is generated by configuring Artifactory maually and the exporting the configuration.</p></div>
<div class="section">
<h5>Uploading artifacts to Artifactory<a name="Uploading_artifacts_to_Artifactory"></a></h5>
<p>The web service <tt>/artifactory/libs-release-local/path/to/jar/</tt> can be used with HTTP POST to install artifacts into the <tt>libs-release-local</tt> local repository.</p>
<p>In the model there is included an example which illustrates how an artifact can uploaded, e.g. WebLogic full client (JAR). The example is commented out to avoid run time fauilure due to the JAR is missing:</p>
<div class="source">
<pre>&lt;shp:copy-to source=&quot;modulepath:bin/${weblogic-client-1212-jar}&quot; destination=&quot;${tmp-dir}/${weblogic-client-1212-jar}&quot; substitute-variables=&quot;false&quot; chmod=&quot;775&quot; /&gt;
&lt;shp:execute command=&quot;curl -u ${rm-user}:${rm-pwd} -X PUT  -T ${tmp-dir}/${weblogic-client-1212-jar} http://${resource.host}:${rm-port}${rm-ws-upload-artifact}/oracle/weblogic-full-client/12.1.2/${weblogic-client-1212-jar}&quot; /&gt;            
&lt;shp:execute command=&quot;rm -f ${tmp-dir}/${weblogic-client-1212-jar}&quot; /&gt;            
</pre></div></div>
<div class="section">
<h5>Bulid integration with Artifactory<a name="Bulid_integration_with_Artifactory"></a></h5>
<p>The Maven configuration file <tt>/var/lib/jenkins/settings.xml</tt> is referenced by build jobs. The file defines the repositories used by Maven to resolve dependencies:</p>
<div class="source">
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;settings xsi:schemaLocation=&quot;http://maven.apache.org/SETTINGS/1.1.0 http://maven.apache.org/xsd/settings-1.1.0.xsd&quot; xmlns=&quot;http://maven.apache.org/SETTINGS/1.1.0&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;
  &lt;servers&gt;
    &lt;server&gt;
      &lt;username&gt;admin&lt;/username&gt;
      &lt;id&gt;central&lt;/id&gt;
    &lt;/server&gt;
    &lt;server&gt;
      &lt;username&gt;admin&lt;/username&gt;
      &lt;id&gt;snapshots&lt;/id&gt;
    &lt;/server&gt;
  &lt;/servers&gt;
  &lt;mirrors&gt;
    &lt;mirror&gt;
      &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;
      &lt;name&gt;repo&lt;/name&gt;
      &lt;url&gt;http://192.168.34.10:8081/artifactory/repo&lt;/url&gt;
      &lt;id&gt;repo&lt;/id&gt;
    &lt;/mirror&gt;
  &lt;/mirrors&gt;
  &lt;profiles&gt;
    &lt;profile&gt;
      &lt;repositories&gt;
        &lt;repository&gt;
          &lt;snapshots&gt;
            &lt;enabled&gt;false&lt;/enabled&gt;
          &lt;/snapshots&gt;
          &lt;id&gt;central&lt;/id&gt;
          &lt;name&gt;libs-release&lt;/name&gt;
          &lt;url&gt;http://192.168.34.10:8081/artifactory/libs-release&lt;/url&gt;
        &lt;/repository&gt;
        &lt;repository&gt;
          &lt;snapshots /&gt;
          &lt;id&gt;snapshots&lt;/id&gt;
          &lt;name&gt;libs-snapshot&lt;/name&gt;
          &lt;url&gt;http://192.168.34.10:8081/artifactory/libs-snapshot&lt;/url&gt;
        &lt;/repository&gt;
      &lt;/repositories&gt;
      &lt;pluginRepositories&gt;
        &lt;pluginRepository&gt;
          &lt;snapshots&gt;
            &lt;enabled&gt;false&lt;/enabled&gt;
          &lt;/snapshots&gt;
          &lt;id&gt;central&lt;/id&gt;
          &lt;name&gt;plugins-release&lt;/name&gt;
          &lt;url&gt;http://192.168.34.10:8081/artifactory/plugins-release&lt;/url&gt;
        &lt;/pluginRepository&gt;
        &lt;pluginRepository&gt;
          &lt;snapshots /&gt;
          &lt;id&gt;snapshots&lt;/id&gt;
          &lt;name&gt;plugins-snapshot&lt;/name&gt;
          &lt;url&gt;http://192.168.34.10:8081/artifactory/plugins-snapshot&lt;/url&gt;
        &lt;/pluginRepository&gt;
      &lt;/pluginRepositories&gt;
      &lt;id&gt;artifactory&lt;/id&gt;
    &lt;/profile&gt;
  &lt;/profiles&gt;
  &lt;activeProfiles&gt;
    &lt;activeProfile&gt;artifactory&lt;/activeProfile&gt;
  &lt;/activeProfiles&gt;
&lt;/settings&gt;
</pre></div>
<p>An <b>important</b> configuration in the file is the <tt>mirror</tt> definition which configures Maven to access Artifactory at <tt>http://192.168.34.10:8081/artifactory/repo</tt> for resolution of <b>all</b> dependencies. This controls the resolution of dependencies and it speeds up the build process.</p>
<p>The configuration file can be generated by exporting it from Artifactory. </p></div></div></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                   2018.
          All Rights Reserved.      
                    
      </div>

                          
        
                </div>
    </footer>
  </body>
</html>
