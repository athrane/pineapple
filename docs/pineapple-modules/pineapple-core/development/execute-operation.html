<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 13 Apr 2017
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Allan Thrane Andersen" />
    <meta name="Date-Revision-yyyymmdd" content="20170413" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Pineapple core component - Execution operation</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />

      
    <script type="text/javascript" src="../js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Pineapple core component</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                              <li class="">
                    <a href="../../../index.html" title="Pineapple Home">
        Pineapple Home</a>
        </li>
      <li class="divider ">/</li>
            <li class="">
                    <a href="../../" title="Pineapple modules">
        Pineapple modules</a>
        </li>
      <li class="divider ">/</li>
            <li class="">
                    <a href="../" title="Pineapple core component">
        Pineapple core component</a>
        </li>
      <li class="divider ">/</li>
        <li class="">Execution operation</li>
        
                
                    
                  <li id="publishDate" class="pull-right">Last Published: 13 Apr 2017</li> 
            
                            </ul>
      </div>

                  
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Project Overview</li>
                                
      <li>
    
                          <a href="../../../index.html" title="Home">
          <i class="none"></i>
        Home</a>
            </li>
                  
      <li>
    
                          <a href="../../../usage/installation.html" title="Installation">
          <i class="none"></i>
        Installation</a>
            </li>
                  
      <li>
    
                          <a href="../../../usage/index.html" title="For Users">
          <i class="none"></i>
        For Users</a>
            </li>
                  
      <li>
    
                          <a href="../../../development/index.html" title="For Developers">
          <i class="none"></i>
        For Developers</a>
            </li>
                  
      <li>
    
                          <a href="../../../usage/terms.html" title="Terms and Conditions">
          <i class="none"></i>
        Terms and Conditions</a>
            </li>
                              <li class="nav-header">Clients</li>
                                
      <li>
    
                          <a href="../../../pineapple-applications/pineapple-web-application/pineapple-standalone-web-client/index.html" title="Standalone Web Application">
          <i class="none"></i>
        Standalone Web Application</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-applications/pineapple-web-application/pineapple-web-application-war/index.html" title="Deployable Web Application">
          <i class="none"></i>
        Deployable Web Application</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-applications/pineapple-maven-plugin/index.html" title="Maven Plugin">
          <i class="none"></i>
        Maven Plugin</a>
            </li>
                              <li class="nav-header">Plugins</li>
                                
      <li>
    
                          <a href="../../../pineapple-plugins/pineapple-agent-plugin/index.html" title="Agent">
          <i class="none"></i>
        Agent</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-plugins/pineapple-composite-execution-plugin/index.html" title="Composite Execution">
          <i class="none"></i>
        Composite Execution</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-plugins/pineapple-ssh-plugin/index.html" title="SSH">
          <i class="none"></i>
        SSH</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-plugins/pineapple-docker-plugin/index.html" title="Docker">
          <i class="none"></i>
        Docker</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-modules/pineapple-infrastructure-test-plugin/index.html" title="Infrastructure Test">
          <i class="none"></i>
        Infrastructure Test</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-plugins/pineapple-fusion-middleware-installation-plugin/index.html" title="Fusion Middleware Installation">
          <i class="none"></i>
        Fusion Middleware Installation</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-plugins/pineapple-weblogic-installation-plugin/index.html" title="WebLogic Installation">
          <i class="none"></i>
        WebLogic Installation</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-modules/pineapple-weblogic-deployment-plugin/index.html" title="WebLogic Deployment">
          <i class="none"></i>
        WebLogic Deployment</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-plugins/pineapple-weblogic-scripting-tool-plugin/index.html" title="WebLogic Scripting Tool (WLST)">
          <i class="none"></i>
        WebLogic Scripting Tool (WLST)</a>
            </li>
                  
      <li>
    
                          <a href="../../../pineapple-modules/pineapple-weblogic-jmx-plugin/index.html" title="WebLogic JMX">
          <i class="none"></i>
        WebLogic JMX</a>
            </li>
                              <li class="nav-header">API's</li>
                                
      <li>
    
                          <a href="../../../pineapple-applications/pineapple-web-application/pineapple-web-application-war/usage/rest.html" title="REST">
          <i class="none"></i>
        REST</a>
            </li>
                  
      <li>
    
                          <a href="../../../development/plugin-framework.html" title="Plugin Framework">
          <i class="none"></i>
        Plugin Framework</a>
            </li>
                              <li class="nav-header">Additional Information</li>
                                
      <li>
    
                          <a href="http://pineapplesoftware.blogspot.com" class="externalLink" title="The Pineapple Project Blog">
          <i class="none"></i>
        The Pineapple Project Blog</a>
            </li>
                  
      <li>
    
                          <a href="http://exceptiontrail.blogspot.com" class="externalLink" title="Pineapple Exception Trail Blog">
          <i class="none"></i>
        Pineapple Exception Trail Blog</a>
            </li>
                              <li class="nav-header">Project Tools</li>
                                
      <li>
    
                          <a href="https://bintray.com/pineapple/maven/com.alpha.pineapple" class="externalLink" title="Downloads">
          <i class="none"></i>
        Downloads</a>
            </li>
                  
      <li>
    
                          <a href="https://github.com/athrane/pineapple" class="externalLink" title="Source Code">
          <i class="none"></i>
        Source Code</a>
            </li>
                  
      <li>
    
                          <a href="https://github.com/athrane/pineapple/issues" class="externalLink" title="Issue Tracker">
          <i class="none"></i>
        Issue Tracker</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                        
      <li>
    
                          <a href="../project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                   
    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>

    
    <div class="g-plusone" data-href="https://pineapple.dev.java.net" data-size="tall" ></div>

                   <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                        
        <div id="bodyColumn"  class="span10" >
                                  
            <!-- NOTE: For help with the syntax of this file, see: --><!-- http://maven.apache.org/guides/mini/guide-apt-format.html --><div class="section">
<h2>Execution operation<a name="Execution_operation"></a></h2>
<p>The execution takes place when a client invokes the core component to execute a operation. </p>
<div class="section">
<h3>Overview<a name="Overview"></a></h3>
<p>When the method <tt>public ExecutionInfo executeOperation(String operation, String environment, String module)</tt> is invoked, the core component starts this execution sequence:</p>
<ol style="list-style-type: decimal">
<li>Validate the method arguments.</li>
<li>Resolves a <tt>ModuleInfo</tt> object from the module repository based on the module id and environment.</li>
<li>Creates a <tt>ExecutionInfo</tt> object using the module info, environment and operation id as input.</li>
<li>Start the asynchronous task execution by invoking the method <tt>execute( executionInfo, pluginActivator )</tt> on an instance of <tt>AsyncOperationTaskImpl</tt>.</li></ol></div>
<div class="section">
<h3>Execution of the the asynchronous task <a name="Execution_of_the_the_asynchronous_task"></a></h3>
<p>The execution of <tt>AsyncOperationTaskImpl</tt> delegates the execution to the <tt>OperationTaskImpl</tt>. </p></div>
<div class="section">
<h3>Execution of the the synchronous task <a name="Execution_of_the_the_synchronous_task"></a></h3>
<p>The execution of <tt>OperationTaskImpl</tt> proceeds as:</p>
<ol style="list-style-type: decimal">
<li>The command runner is configured with the execution result object.</li>
<li>A new execution result is created. The purpose of the result is to capture the outcome of the commands which sets up the execution of the operation. The result is considered <i>detached</i> because it isn't child of the main execution result for the operation which is contain by the execution info object. </li>
<li>The command runner is configured with the <i>detached</i> execution result.</li>
<li>A new Chain context is created. </li>
<li>The context is registered with the execution context repository (for access by plugin providers). </li>
<li>The method <tt>initializeOperation(info, context)</tt> is invoked which add the property to the context as input for the command:
<ul>
<li>the execution info object is added under the key <tt>execution-info</tt></li></ul>
<ol style="list-style-type: decimal">
<li>...then the <tt>InitializeOperationCommand</tt> is run. The command add these properties to the context as input for the subsequent commands:
<ul>
<li><i>module file name</i> is added under the key <tt>module-file</tt></li>
<li><i>module model file name</i> is added under the key <tt>module-model-file</tt></li></ul></li>
<li>The message describing the outcome of the command execution is copied from the command result to the operation result. The command result is a child result of the <i>detached</i> result described above. </li>
<li>If the command execution failed then:
<ul>
<li>The operation result is completed as failed.</li>
<li>Any stack trace stored in the command result is copied to the operation result.</li>
<li>Execution of the operation is aborted. </li></ul></li></ol></li>
<li>It is queried from the module info whether the module descriptor (module.xml) is defined. If the descriptor is defined then the method <tt>loadModule(info, context)</tt> is invoked which runs the <tt>UnmarshallJAXBObjectsCommand</tt> command. The command loads the module and adds it to this property to the context:
<ul>
<li><i>module</i> is added under the key <tt>unmarshalling-result</tt></li></ul>
<ol style="list-style-type: decimal">
<li>If the command execution was successful then:
<ul>
<li>The object stored under the context key <tt>unmarshalling-result</tt> is type cast to <tt>com.alpha.pineapple.model.module.Module</tt>.</li>
<li>The object is stored in the context under the key <tt>module</tt>.</li></ul></li>
<li>The message describing the outcome of the command execution is copied from the command result to the operation result. The command result is a child result of the <i>detached</i> result described above. </li>
<li>If the command execution failed then:
<ul>
<li>The operation result is completed as failed.</li>
<li>Any stack trace stored in the command result is copied to the operation result.</li>
<li>Execution of the operation is aborted. </li></ul></li></ol></li>
<li>If the descriptor isn't defined then the method <tt>handleUndefinedModule(info, context)</tt> is invoked which creates a null module with the module directory name as module name and with default version 1.0.0.
<ul>
<li>The object is stored in the context under the key <tt>module</tt>.</li></ul></li>
<li>The method <tt>loadModuleModel(info, context)</tt> is invoked which runs the <tt>UnmarshallJAXBObjectsCommand</tt> command. If The command loads the module and adds it to this property to the context:
<ul>
<li><i>module model</i> is added under the key <tt>unmarshalling-result</tt></li></ul>
<ol style="list-style-type: decimal">
<li>If the command execution was successful then:
<ul>
<li>The object stored under the context key <tt>unmarshalling-result</tt> is type cast to <tt>com.alpha.pineapple.model.module.model.Models</tt>.</li>
<li>The object is stored in the context under the key <tt>module-model</tt>.</li></ul></li>
<li>The message describing the outcome of the command execution is copied from the command result to the operation result. The command result is a child result of the <i>detached</i> result described above. </li>
<li>If the command execution failed then:
<ul>
<li>The operation result is completed as failed.</li>
<li>Any stack trace stored in the command result is copied to the operation result.</li>
<li>Execution of the operation is aborted. </li></ul></li></ol></li>
<li>The method <tt>invokePlugins(info, context)</tt> is invoked which runs the <tt>InvokePluginsCommand</tt> command. The command starts execution of the models contained in module model document.
<ol style="list-style-type: decimal">
<li>If the command execution failed then:
<ul>
<li>The operation result is completed as failed.</li>
<li>Any stack trace stored in the command result is copied to the operation result.</li>
<li>Execution of the operation is aborted. </li></ul></li></ol></li>
<li>The context is unregistered with the context repository. </li></ol></div>
<div class="section">
<h3>Execution of the initialize operation command<a name="Execution_of_the_initialize_operation_command"></a></h3>
<p>The command reads these values from the context::</p>
<ul>
<li><i>execution-info</i> - the execution info object. </li></ul>
<p>The command initializes a operation by: </p>
<ol style="list-style-type: decimal">
<li>Test for existence of module file <tt>module.xml</tt> at <tt>${modules-directory}/${module}/module.xml</tt>.</li>
<li>The location of the module file <tt>module.xml</tt> is added to the context under the key <tt>module-file</tt>. </li>
<li>Test for existence of module model file <tt>${environment}.xml</tt> at <tt>${modules-directory}/${module}/models/${module}</tt>.</li>
<li>The location of the module model <tt>${environment}.xml</tt> is added to the context under the key <tt>module-model-file</tt>.</li></ol></div>
<div class="section">
<h3>Execution of the invoke plugins command<a name="Execution_of_the_invoke_plugins_command"></a></h3>
<p>The command reads these values from the context::</p>
<ul>
<li><i>module</i> - The module object.</li>
<li><i>module-model</i> - The module model object. </li>
<li><i>execution-info</i> - meta information about the operation being executed. </li>
<li><i>plugin-activator</i> - The plugin activator object. </li></ul>
<ol style="list-style-type: decimal">
<li>Meta data about the operation is from the execution info and added to the root execution result. These fields are added:
<ul>
<li>Operation name.</li>
<li>Environment name.</li>
<li>Module name</li>
<li>Module file name.</li></ul></li>
<li>Read the root execution result read from the execution info object. </li>
<li>Read the continuation policy from the model and update the root result.</li>
<li>The list of aggregated models is read from the from the module model and an iteration is done over each of them: 
<ol style="list-style-type: decimal">
<li><a href="#Step_4.1:_Enforce_continuation_policy">Enforce continuation policy</a>. </li>
<li>A new child execution result is created to track the execution of the aggregated model by invoking: <tt>rootResult.addChild( &quot;...a description of the aggregated model...&quot; )</tt> </li>
<li>The target-resource is read from the model.</li>
<li>If the plugin doesn't support input marshalling then the plugin is executed by:
<ol style="list-style-type: decimal">
<li>The operation class is looked up in the plugin-activator using the environment, the target-resource and the operation-id.</li>
<li>The session class is looked up in the plugin-activator using the environment and the target-resource.</li>
<li>The operation class invoked with NULL content. </li>
<li><a href="#Step_4.4.6:_Execute_triggers">Execute trigger(s)</a>. </li></ol></li>
<li>A unmarshaller is looked up in the plugin activator using the <tt>environment</tt> and the <tt>target resource</tt>.</li>
<li>The content-root is read from the model.</li>
<li>Iteration over each of the sub elements contained by the content-root:
<ol style="list-style-type: decimal">
<li>A DOMSource is created with the element as argument.</li>
<li>The element is unmarshalled using the unmarshaller from step 4.5.</li>
<li><a href="#Step_4.7.3:_Resolution_of_the_plugin_operation">Resolution of the plugin operation</a>. </li>
<li>The session class is looked up in the plugin activator using the <tt>environment</tt> and the <tt>target resource</tt>.</li>
<li>The element is proxied to support runtime manipulation of he model context, including variable substitution.</li>
<li>The operation class invoked using the unmarshalled content from step 4.7.2.</li>
<li><a href="#Step_4.7.7:_Execute_triggers">Execute trigger(s)</a>.</li>
<li>If the state of the operation result is still <i>executing</i> after execution of the operation, then the state is forced to <i>failure</i> due to he failure of the plugin to set the state properly.</li></ol></li></ol></li>
<li>A message describing the aggregated result of the execution of the aggregated models is added to the root execution result. </li>
<li>The state of the root execution result is set to <i>computed</i> to trigger a computation of its state based on the results of its children, i.e. the aggregated models.</li></ol>
<p><b>Please notice:</b></p>
<ul>
<li>The state of the execution results for the aggregated models is set by the plugins in the invoked operation in step 4.7.7. </li></ul>
<div class="section">
<h4>Step 4.1: Enforce continuation policy<a name="Step_4.1:_Enforce_continuation_policy"></a></h4>
<p>The continuation policy of the root result is read.</p>
<p>If the policy state signal that execution should be aborted then execution of the aggregated model is aborted before it is even begun.</p></div>
<div class="section">
<h4>Step 4.4.6: Execute triggers <a name="Step_4.4.6:_Execute_triggers"></a></h4>
<p>See section 4.7.7</p></div>
<div class="section">
<h4>Step 4.7.1 - 4.7.7: Error handling<a name="Step_4.7.1_-_4.7.7:_Error_handling"></a></h4>
<p>If any exception is thrown during the execution of a single model then two types of exceptions are caught:</p>
<ul>
<li><tt>RuntimeException</tt> - use to tunnel exceptions from the <tt>SessionHandler</tt>.</li>
<li><tt>Exception</tt> - unexpected errors.</li></ul></div>
<div class="section">
<h4>Tunneling exceptions from the session handler<a name="Tunneling_exceptions_from_the_session_handler"></a></h4>
<p>The purpose of the session handler is to connect the plugin session prior to invoking the operation and to disconnect afterwards. The session handler achieves its goal by proxying all plugin operations which supports input marshalling.</p>
<p>When an exception occurs in the session handler then the exception is caught and rethrown immediately in a <tt>RuntimeException</tt>. The purpose of the runtime exception is to channel the exception to the invoking <tt>InvokePluginsCommand</tt>, see step 3.6.6. The <tt>InvokePluginsCommand</tt> will catch the exception and process the embedded exception appropriately by setting an error message and completing the operation result with the <i>Error</i> state.</p>
<p>The <tt>SessionHandlerImpl</tt> supports tunneling of these exceptions:</p>
<ul>
<li><tt>SessionConnectException</tt> thrown when an error occurs during connecting to a plugin session.</li>
<li><tt>SessionDisconnectException</tt> thrown when an error occurs during disconnecting from a plugin session.</li>
<li><tt>PluginExecutionFailedException</tt> thrown when an error occurs during execution of a plugin.</li>
<li><tt>IllegalArgumentException</tt> thrown when validation of a method argument fails within some plugin code.</li></ul></div>
<div class="section">
<h4>Step 4.7.3: Resolution of the plugin operation<a name="Step_4.7.3:_Resolution_of_the_plugin_operation"></a></h4>
<p>The operation class is looked up in the plugin activator using the <tt>environment</tt>, the <tt>target resource</tt> and the <tt>operation ID</tt>:</p>
<p>The plugin operation is resolved using <tt>PluginActivator.getOperation(..)</tt> which uses this algorithm for resolution of the operation:</p>
<ol style="list-style-type: decimal">
<li>Resolve the plugin ID from the <tt>environment</tt> and the <tt>target resource</tt> in the <tt>ResourceRepository</tt>.</li>
<li>Lookup the operation from the <tt>PluginRepository</tt>.</li>
<li>Lookup the <tt>PluginInfo</tt> from the <tt>PluginRepository</tt>.</li>
<li>If the plugin doesn't support session handling then return the operation.</li>
<li>Otherwise, get the resource and credential for the operation.</li>
<li>Create a <tt>SessionHandler</tt> to proxy the operation. </li>
<li>Return the session handler.</li></ol></div>
<div class="section">
<h4>Step 4.7.4: Resolving the plugin session<a name="Step_4.7.4:_Resolving_the_plugin_session"></a></h4>
<p>The plugin session is resolved using <tt>PluginActivator.getSession(..)</tt>.</p>
<p>The resolution of the session is done in two steps:</p>
<ol style="list-style-type: decimal">
<li>Resolve the plugin ID from the <tt>environment</tt> and the <tt>target resource</tt> in the <tt>ResourceRepository</tt>.</li>
<li>Lookup the session from the <tt>PluginRepository</tt></li></ol></div>
<div class="section">
<h4>Step 4.7.5: Proxying the model to support variable substitution<a name="Step_4.7.5:_Proxying_the_model_to_support_variable_substitution"></a></h4>
<p>TODO:...</p></div>
<div class="section">
<h4>Step 4.7.7: Execute triggers <a name="Step_4.7.7:_Execute_triggers"></a></h4>
<p>The algorithm for execution of the triggers are: </p>
<ol style="list-style-type: decimal">
<li>Resolve which triggers to run using the rules:
<ul>
<li>The value of the <tt>on-target-operation</tt> attribute is null.</li>
<li>The value of the <tt>on-target-operation</tt> attribute is empty.</li>
<li>The value of the <tt>on-target-operation</tt> attribute is the wild card value &quot;*&quot;.</li>
<li>The value of the <tt>on-target-operation</tt> attribute is identical to the operation that the model was invoked with.</li>
<li>The value of the <tt>on-target-operation</tt> attribute is a list value and one of the values in the list is identical to the operation that the model was invoked with.</li></ul>
<p>and:</p>
<ul>
<li>The value of the <tt>on-result</tt> attribute is the wild card value &quot;*&quot;.</li>
<li>The value of the <tt>on-result</tt> attribute is identical to the result that the model execution concluded with.</li>
<li>The value of the <tt>on-result</tt> attribute is a list value and one of the values in the list is identical to the result that the model execution concluded with.</li></ul></li>
<li>Get the synchronous operation task for the administration API.</li>
<li>Execute the trigger using attached execution <tt>operationTask.executeComposite(..)</tt>.</li></ol></div></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                   2017.
          All Rights Reserved.      
                    
      </div>

                          
        
                </div>
    </footer>
  </body>
</html>
